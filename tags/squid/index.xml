<?xml version="1.0" encoding="utf-8" standalone="yes" ?>
<rss version="2.0" xmlns:atom="http://www.w3.org/2005/Atom">
  <channel>
    <title>Squid on shinayoshi&#39;s note</title>
    <link>http://www.shinayoshi.net/tags/squid/</link>
    <description>Recent content in Squid on shinayoshi&#39;s note</description>
    <generator>Hugo -- gohugo.io</generator>
    <language>ja</language>
    <copyright>Copyright (c) 2016 shinayoshi</copyright>
    <lastBuildDate>Mon, 22 Aug 2016 22:24:35 +0900</lastBuildDate>
    <atom:link href="http://www.shinayoshi.net/tags/squid/index.xml" rel="self" type="application/rss+xml" />
    
    <item>
      <title>Raspbian(Jessie)にSquidをインストールする</title>
      <link>http://www.shinayoshi.net/post/2016/08/22/installing-squid-on-raspbian/</link>
      <pubDate>Mon, 22 Aug 2016 22:24:35 +0900</pubDate>
      
      <guid>http://www.shinayoshi.net/post/2016/08/22/installing-squid-on-raspbian/</guid>
      <description>

&lt;p&gt;Raspbian(Jessie)にSquidをインストールして内部NW向けプロキシサーバを構築するまでのメモです。&lt;/p&gt;

&lt;h2 id=&#34;raspbianの初期設定:b44e2973592bad70879d3cac4bdad4df&#34;&gt;Raspbianの初期設定&lt;/h2&gt;

&lt;p&gt;過去のブログ記事を参考に初期設定を実施する。&lt;/p&gt;

&lt;ul&gt;
&lt;li&gt;パッケージの最新化&lt;/li&gt;
&lt;li&gt;パッケージのインストール
&amp;ndash; chkconfig
&amp;ndash; tcpdump
&amp;ndash; telnet
&amp;ndash; dnsutils&lt;/li&gt;
&lt;li&gt;IPアドレスの固定化&lt;/li&gt;
&lt;li&gt;NTP設定&lt;/li&gt;
&lt;li&gt;rpi-configの設定
&amp;ndash; ディスク拡張
&amp;ndash; 文字コード設定
&amp;ndash; タイムゾーン設定
&amp;ndash; Wifiの国設定
&amp;ndash; ホスト名変更&lt;/li&gt;
&lt;li&gt;公開鍵認証方式の設定&lt;/li&gt;
&lt;li&gt;IPv6の無効化&lt;/li&gt;
&lt;li&gt;SELinuxの無効化&lt;/li&gt;
&lt;li&gt;iptablesの設定&lt;/li&gt;
&lt;li&gt;logwatchのインストール&lt;/li&gt;
&lt;li&gt;Zabbix Agentのインストール・監視登録&lt;/li&gt;
&lt;li&gt;SNMPDのインストール・Cacti登録&lt;/li&gt;
&lt;/ul&gt;

&lt;h2 id=&#34;squidのインストール:b44e2973592bad70879d3cac4bdad4df&#34;&gt;Squidのインストール&lt;/h2&gt;

&lt;p&gt;Squidをインストールする。&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;$ sudo apt-get install squid
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;Squidを設定する。&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;$ sudo cp -p /etc/squid/squid.conf{,.org}
$ sudo vi /etc/squid/squid.conf
$ sudo diff /etc/squid/squid.conf.org /etc/squid/squid.conf
609,611c609,616
&amp;lt; acl localnet src 10.0.0.0/8	# RFC1918 possible internal network
&amp;lt; acl localnet src 172.16.0.0/12	# RFC1918 possible internal network
&amp;lt; acl localnet src 192.168.0.0/16	# RFC1918 possible internal network
---
&amp;gt; #acl localnet src 10.0.0.0/8	# RFC1918 possible internal network
&amp;gt; #acl localnet src 172.16.0.0/12	# RFC1918 possible internal network
&amp;gt; #acl localnet src 192.168.0.0/16	# RFC1918 possible internal network
&amp;gt; acl localnet src 192.168.10.0/24
&amp;gt; acl localnet src 192.168.20.0/24
&amp;gt; acl localnet src 192.168.30.0/24
&amp;gt; acl localnet src 192.168.40.0/24
&amp;gt; 
676c681
&amp;lt; #http_access allow localnet
---
&amp;gt; http_access allow localnet
1738a1744
&amp;gt; cache_mem 256 MB
1747a1754
&amp;gt; maximum_object_size_in_memory 512 KB
1945a1953
&amp;gt; cache_dir ufs /var/spool/squid 10000 16 256
1988a1997
&amp;gt; maximum_object_size 20480 KB
2097a2107
&amp;gt; logformat combined %&amp;gt;a %ui %un [%tl] &amp;quot;%rm %ru HTTP/%rv&amp;quot; %Hs %&amp;lt;st &amp;quot;%{Referer}&amp;gt;h&amp;quot; &amp;quot;%{User-Agent}&amp;gt;h&amp;quot; %Ss:%Sh
2121c2131,2132
&amp;lt; access_log /var/log/squid/access.log squid
---
&amp;gt; #access_log /var/log/squid/access.log squid
&amp;gt; access_log /var/log/squid/access.log combined
2217a2229
&amp;gt; emulate_httpd_log off
2751c2763,2768
&amp;lt; refresh_pattern .		0	20%	4320
---
&amp;gt; refresh_pattern -i \.(gif|png|jpe?g|tif?f|bmp)$ 1440 25% 10080
&amp;gt; refresh_pattern -i \.(mpe?g|avi|ra?m|wmv|mov)$ 1440 25% 10080
&amp;gt; refresh_pattern -i \.(wav|mp3|mid)$ 1440 25% 10080
&amp;gt; refresh_pattern -i \.(class|swf|pdf)$ 1440 25% 10080
&amp;gt; refresh_pattern -i \.(js|css)$ 1440 25% 10080
&amp;gt; refresh_pattern . 45 20% 4320
2944a2962
&amp;gt; via off
3100a3119,3122
&amp;gt; header_access Referer deny all
&amp;gt; header_access X-Forwarded-For deny all
&amp;gt; header_access Via deny all
&amp;gt; header_access Cache-Control deny all
3392a3415
&amp;gt; visible_hostname unknown
4699a4723
&amp;gt; forwarded_for off
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;Squidの設定に不備がないか確認する。&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;$ sudo squid -k parse
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;Squidの設定を有効にする。&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;$ sudo systemctl reload squid
&lt;/code&gt;&lt;/pre&gt;

&lt;ul&gt;
&lt;li&gt;&lt;a href=&#34;http://www.unix-power.net/linux/squid.html&#34;&gt;CentOS Squidの設定&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&#34;http://tech.ckme.co.jp/proxy.shtml&#34;&gt;Proxyサーバの設定（squid）：tech.ckme.co.jp&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&#34;http://nabeshiki.tumblr.com/post/20000083416/2001-sd-squid&#34;&gt;Proxyキャッシュサーバ設定術・Squidの設定(2001年掲載) | なべしき&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&#34;http://blog.asial.co.jp/1076&#34;&gt;Privoxy + Ziproxy + Squidで高速フィルタリングサーバを作ってみた : アシアルブログ&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;

&lt;h2 id=&#34;iptablesの通信許可設定:b44e2973592bad70879d3cac4bdad4df&#34;&gt;iptablesの通信許可設定&lt;/h2&gt;

&lt;p&gt;内部NWからSquidへの通信を許可する。&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;$ sudo iptables -A INPUT -m state --state NEW -m tcp -p tcp -s 192.168.0.0/16 --dport 3128 -j ACCEPT
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;iptablesの設定を保存する。&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;$ sudo sh -c &amp;quot;iptables-save &amp;gt; /etc/iptables/rules.v4&amp;quot;
&lt;/code&gt;&lt;/pre&gt;

&lt;h2 id=&#34;ブラウザのプロキシ設定:b44e2973592bad70879d3cac4bdad4df&#34;&gt;ブラウザのプロキシ設定&lt;/h2&gt;

&lt;p&gt;ブラウザ使用するプロキシ設定をSquidに変更する。&lt;/p&gt;

&lt;p&gt;Squidのログを確認してSquid経由でWebアクセスができていることを確認する。&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;$ sudo cat /var/log/squid/access.log
&lt;/code&gt;&lt;/pre&gt;

&lt;h2 id=&#34;raspbianのプロキシ設定:b44e2973592bad70879d3cac4bdad4df&#34;&gt;Raspbianのプロキシ設定&lt;/h2&gt;

&lt;p&gt;起動時にプロキシを使用するように設定する。&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;$ sudo vi /etc/profile.d/proxy.sh
PROXY=&amp;quot;192.168.20.10:3128&amp;quot;
export http_proxy=&amp;quot;http://${PROXY}&amp;quot;
export https_proxy=&amp;quot;http://${PROXY}&amp;quot;
export no_proxy=&amp;quot;localhost,127.0.0.1,192.168.*&amp;quot;

export HTTP_PROXY=&amp;quot;${http_proxy}&amp;quot;
export HTTPS_PROXY=&amp;quot;${https_proxy}&amp;quot;
export NO_PROXY=&amp;quot;${no_proxy}&amp;quot;
$source /etc/profile.d/proxy.sh
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;上記コマンドではsudo時の環境変数には反映されない。そのため、sudo時には&lt;code&gt;-E&lt;/code&gt;オプションを指定する。&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;$ sudo -E apt-get update
$ sudo -E apt-get upgrade
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;以上&lt;/p&gt;
</description>
    </item>
    
  </channel>
</rss>