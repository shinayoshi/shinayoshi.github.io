<?xml version="1.0" encoding="utf-8" standalone="yes" ?>
<rss version="2.0" xmlns:atom="http://www.w3.org/2005/Atom">
  <channel>
    <title>Raid on shinayoshi&#39;s note</title>
    <link>http://www.shinayoshi.net/tags/raid/</link>
    <description>Recent content in Raid on shinayoshi&#39;s note</description>
    <generator>Hugo -- gohugo.io</generator>
    <language>ja</language>
    <copyright>Copyright (c) 2016 shinayoshi</copyright>
    <lastBuildDate>Fri, 26 Aug 2016 00:01:43 +0900</lastBuildDate>
    <atom:link href="http://www.shinayoshi.net/tags/raid/index.xml" rel="self" type="application/rss+xml" />
    
    <item>
      <title>Raspbian(Jessie)をファイルサーバにする</title>
      <link>http://www.shinayoshi.net/post/2016/08/26/setting-file-server/</link>
      <pubDate>Fri, 26 Aug 2016 00:01:43 +0900</pubDate>
      
      <guid>http://www.shinayoshi.net/post/2016/08/26/setting-file-server/</guid>
      <description>

&lt;p&gt;Raspberry Pi 3をファイルサーバにします。
USB HDD 2台接続してRAID構成を組みます。&lt;/p&gt;

&lt;p&gt;手順とか整理できていないのでコマンドの羅列となりますがご了承ください。
時間があるときに整理します。&lt;/p&gt;

&lt;h2 id=&#34;mdadmのインストール:69e8e0751d383930d692b0b4fd3868b0&#34;&gt;mdadmのインストール&lt;/h2&gt;

&lt;pre&gt;&lt;code&gt;$ sudo apt-get install mdadm
all
&lt;/code&gt;&lt;/pre&gt;

&lt;h2 id=&#34;raid構成の情報を削除:69e8e0751d383930d692b0b4fd3868b0&#34;&gt;RAID構成の情報を削除&lt;/h2&gt;

&lt;pre&gt;&lt;code&gt;$ sudo mdadm --misc --zero-superblock /dev/sda1
$ sudo mdadm --misc --zero-superblock /dev/sdb1
&lt;/code&gt;&lt;/pre&gt;

&lt;h2 id=&#34;ディスクのフォーマット:69e8e0751d383930d692b0b4fd3868b0&#34;&gt;ディスクのフォーマット&lt;/h2&gt;

&lt;pre&gt;&lt;code&gt;$ sudo fdisk /dev/sda
p
d
p
n
(Enter)
(Enter)
(Enter)
(Enter)
p
t
fd
p
w

$ sudo fdisk /dev/sda
p
d
p
n
(Enter)
(Enter)
(Enter)
(Enter)
p
t
fd
p
w
&lt;/code&gt;&lt;/pre&gt;

&lt;h2 id=&#34;ディスクのuuidを確認:69e8e0751d383930d692b0b4fd3868b0&#34;&gt;ディスクのUUIDを確認&lt;/h2&gt;

&lt;pre&gt;&lt;code&gt;$ sudo ls -l /dev/disk/by-id/
合計 0
lrwxrwxrwx 1 root root 13  5月 27 21:58 mmc-USDU1_0x0630017e -&amp;gt; ../../mmcblk0
lrwxrwxrwx 1 root root 15  5月 27 21:58 mmc-USDU1_0x0630017e-part1 -&amp;gt; ../../mmcblk0p1
lrwxrwxrwx 1 root root 15  5月 27 21:58 mmc-USDU1_0x0630017e-part2 -&amp;gt; ../../mmcblk0p2
lrwxrwxrwx 1 root root  9  8月 26 00:12 usb-WD_My_Passport_0741_575831314136333736353632-0:0 -&amp;gt; ../../sdb
lrwxrwxrwx 1 root root 10  8月 26 00:12 usb-WD_My_Passport_0741_575831314136333736353632-0:0-part1 -&amp;gt; ../../sdb1
lrwxrwxrwx 1 root root  9  8月 26 00:12 usb-WD_My_Passport_0820_57583231413734354A554A46-0:0 -&amp;gt; ../../sda
lrwxrwxrwx 1 root root 10  8月 26 00:12 usb-WD_My_Passport_0820_57583231413734354A554A46-0:0-part1 -&amp;gt; ../../sda1
&lt;/code&gt;&lt;/pre&gt;

&lt;h2 id=&#34;mdadmでraidを構築:69e8e0751d383930d692b0b4fd3868b0&#34;&gt;mdadmでraidを構築&lt;/h2&gt;

&lt;pre&gt;&lt;code&gt;$ sudo mdadm --create /dev/md0 --level=1 --raid-devices=2 /dev/disk/by-id/usb-WD_My_Passport_0820_57583231413734354A554A46-0:0-part1 /dev/disk/by-id/usb-WD_My_Passport_0741_575831314136333736353632-0:0-part1
mdadm: /dev/disk/by-id/usb-WD_My_Passport_0820_57583231413734354A554A46-0:0-part1 appears to contain an ext2fs file system
       size=976728000K  mtime=Mon Aug  3 00:40:00 2015
mdadm: /dev/disk/by-id/usb-WD_My_Passport_0820_57583231413734354A554A46-0:0-part1 appears to be part of a raid array:
       level=raid1 devices=2 ctime=Mon Aug  3 00:54:59 2015
mdadm: Note: this array has metadata at the start and
    may not be suitable as a boot device.  If you plan to
    store &#39;/boot&#39; on this device please ensure that
    your boot-loader understands md/v1.x metadata, or use
    --metadata=0.90
mdadm: /dev/disk/by-id/usb-WD_My_Passport_0741_575831314136333736353632-0:0-part1 appears to contain an ext2fs file system
       size=976728000K  mtime=Mon Aug  3 00:40:00 2015
mdadm: /dev/disk/by-id/usb-WD_My_Passport_0741_575831314136333736353632-0:0-part1 appears to be part of a raid array:
       level=raid1 devices=2 ctime=Mon Aug  3 00:54:59 2015
Continue creating array? yes
mdadm: Defaulting to version 1.2 metadata
mdadm: array /dev/md0 started.
&lt;/code&gt;&lt;/pre&gt;

&lt;pre&gt;&lt;code&gt;sudo cat /proc/mdstat
sudo mdadm --detail /dev/md0
&lt;/code&gt;&lt;/pre&gt;

&lt;pre&gt;&lt;code&gt;#これ不要？
$ sudo sh -c &amp;quot;mdadm --detail --scan &amp;gt;&amp;gt; /etc/mdadm/mdadm.conf&amp;quot;
$ sudo update-initramfs -u
&lt;/code&gt;&lt;/pre&gt;

&lt;h2 id=&#34;フォーマット:69e8e0751d383930d692b0b4fd3868b0&#34;&gt;フォーマット&lt;/h2&gt;

&lt;p&gt;md0をext4でフォーマットする。&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;$ sudo mkfs.ext4 /dev/md0
y
&lt;/code&gt;&lt;/pre&gt;

&lt;h2 id=&#34;raidディスクをマウント:69e8e0751d383930d692b0b4fd3868b0&#34;&gt;raidディスクをマウント&lt;/h2&gt;

&lt;pre&gt;&lt;code&gt;$ sudo mkdir /mnt/raid
$ sudo mount -t ext4 /dev/md0 /mnt/raid
$ sudo chmod 775 /mnt/raid
$ sudo chown root:adm /mnt/raid
&lt;/code&gt;&lt;/pre&gt;

&lt;pre&gt;&lt;code&gt;$ sudo blkid
$ sudo cp -p /etc/fstab{,.org}
$ sudo vi /etc/fstab
UUID=640572ce-3999-4cb3-84a0-eeeb2ce1d97d /mnt/raid ext4 defaults,noatime 0 0
&lt;/code&gt;&lt;/pre&gt;

&lt;h2 id=&#34;起動を少し遅延させる:69e8e0751d383930d692b0b4fd3868b0&#34;&gt;起動を少し遅延させる&lt;/h2&gt;

&lt;pre&gt;&lt;code&gt;$ sudo cp -p /boot/cmdline.txt{,.org}
$ sudo vi /boot/cmdline.txt
dwc_otg.lpm_enable=0 console=serial0,115200 console=tty1 root=/dev/mmcblk0p2 rootfstype=ext4 elevator=deadline fsck.repair=yes rootwait rootdelay=5
&lt;/code&gt;&lt;/pre&gt;

&lt;pre&gt;&lt;code&gt;$ sudo reboot
$ df
$ sudo mdadm --detail /dev/md0
$ sudo cat /proc/mdstat
&lt;/code&gt;&lt;/pre&gt;

&lt;h2 id=&#34;ディスクの同期速度を変更する:69e8e0751d383930d692b0b4fd3868b0&#34;&gt;ディスクの同期速度を変更する&lt;/h2&gt;

&lt;pre&gt;&lt;code&gt;$ cat /proc/sys/dev/raid/speed_limit_min 
1000
$ sudo sh -c &amp;quot;echo 50000 &amp;gt; /proc/sys/dev/raid/speed_limit_min&amp;quot;
$ cat /proc/sys/dev/raid/speed_limit_min 
50000
&lt;/code&gt;&lt;/pre&gt;

&lt;h2 id=&#34;raidの停止:69e8e0751d383930d692b0b4fd3868b0&#34;&gt;raidの停止&lt;/h2&gt;

&lt;pre&gt;&lt;code&gt;$ sudo mdadm --misc --stop /dev/md0
&lt;/code&gt;&lt;/pre&gt;

&lt;h2 id=&#34;nfsサーバ構築:69e8e0751d383930d692b0b4fd3868b0&#34;&gt;NFSサーバ構築&lt;/h2&gt;

&lt;pre&gt;&lt;code&gt;$ sudo apt-get install nfs-kernel-server
$ sudo cp -p /etc/exports{,.org}
$ sudo vi /etc/exports
/mnt/raid       192.168.40.0/255.255.255.0(rw,insecure,all_squash,sync,no_subtree_check)
$ sudo systemctl restart nfs-kernel-server
$ sudo exportfs -v
&lt;/code&gt;&lt;/pre&gt;

&lt;h3 id=&#34;sambaサーバ構築:69e8e0751d383930d692b0b4fd3868b0&#34;&gt;Sambaサーバ構築&lt;/h3&gt;

&lt;pre&gt;&lt;code&gt;$ sudo apt-get install samba
$ sudo cp -p /etc/samba/smb.conf{,.org}
$ sudo vi /etc/samba/smb.conf
$ diff /etc/samba/smb.conf.org /etc/samba/smb.conf
24a25,31
&amp;gt;    unix charset = UTF-8
&amp;gt;    dos charset = CP932
&amp;gt;    hosts allow = 192.168.40.
&amp;gt; 
&amp;gt;    load printers = no
&amp;gt;    printing = bsd
&amp;gt;    printcap name = /dev/null
117c124
&amp;lt;    map to guest = bad user
---
&amp;gt;    map to guest = Never
183c190
&amp;lt;    usershare allow guests = yes
---
&amp;gt;    usershare allow guests = no
187,189c194,196
&amp;lt; [homes]
&amp;lt;    comment = Home Directories
&amp;lt;    browseable = no
---
&amp;gt; ;[homes]
&amp;gt; ;   comment = Home Directories
&amp;gt; ;   browseable = no
193c200
&amp;lt;    read only = yes
---
&amp;gt; ;   read only = yes
197c204
&amp;lt;    create mask = 0700
---
&amp;gt; ;   create mask = 0700
201c208
&amp;lt;    directory mask = 0700
---
&amp;gt; ;   directory mask = 0700
208c215
&amp;lt;    valid users = %S
---
&amp;gt; ;   valid users = %S
231,238c238,245
&amp;lt; [printers]
&amp;lt;    comment = All Printers
&amp;lt;    browseable = no
&amp;lt;    path = /var/spool/samba
&amp;lt;    printable = yes
&amp;lt;    guest ok = no
&amp;lt;    read only = yes
&amp;lt;    create mask = 0700
---
&amp;gt; ;[printers]
&amp;gt; ;   comment = All Printers
&amp;gt; ;   browseable = no
&amp;gt; ;   path = /var/spool/samba
&amp;gt; ;   printable = yes
&amp;gt; ;   guest ok = no
&amp;gt; ;   read only = yes
&amp;gt; ;   create mask = 0700
242,247c249,254
&amp;lt; [print$]
&amp;lt;    comment = Printer Drivers
&amp;lt;    path = /var/lib/samba/printers
&amp;lt;    browseable = yes
&amp;lt;    read only = yes
&amp;lt;    guest ok = no
---
&amp;gt; ;[print$]
&amp;gt; ;   comment = Printer Drivers
&amp;gt; ;   path = /var/lib/samba/printers
&amp;gt; ;   browseable = yes
&amp;gt; ;   read only = yes
&amp;gt; ;   guest ok = no
254a262,269
&amp;gt; [share]
&amp;gt;    path = /mnt/raid
&amp;gt;    writable = yes
&amp;gt;    valid users = @sambashare
&amp;gt;    force user = root
&amp;gt;    force group = adm
&amp;gt;    create mask = 0664
&amp;gt;    directory mask = 0775
$ testparm /etc/samba/smb.conf
$ sudo systemctl restart smbd
$ sudo systemctl restart nmbd
&lt;/code&gt;&lt;/pre&gt;

&lt;h3 id=&#34;samba用のユーザを作成する:69e8e0751d383930d692b0b4fd3868b0&#34;&gt;Samba用のユーザを作成する&lt;/h3&gt;

&lt;pre&gt;&lt;code&gt;$ sudo useradd samba -u 1100 -g sambashare -s /bin/false
$ sudo passwd samba
$ sudo pdbedit -a -u samba
&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;以上&lt;/p&gt;
</description>
    </item>
    
  </channel>
</rss>