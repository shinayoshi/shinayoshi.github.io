
<!DOCTYPE html>
<html class="no-js" lang="ja">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    
    <meta name="generator" content="Hugo 0.15" />

    <base href="http://www.shinayoshi.net/" />
    <title>shinayoshi&#39;s note</title>
    <link rel="canonical" href="http://www.shinayoshi.net/" />
    <link href="http://www.shinayoshi.net//img/favicon.ico" type="image/vnd.microsoft.icon" rel="icon" />
    <link href="http://www.shinayoshi.net/index.xml" rel="alternate" title="shinayoshi&#39;s note" type="application/rss+xml" />

    
    <link href="http://www.shinayoshi.net//css/bootstrap.min.css" rel="stylesheet">

    <link href="https://maxcdn.bootstrapcdn.com/font-awesome/4.4.0/css/font-awesome.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://yandex.st/highlightjs/8.0/styles/default.min.css">

    
    
    
  </head>
  <body>
    <div id="wrap">


      <header role="banner">
        <nav class="navbar navbar-default" role="navigation">
          <div class="container">
            <div class="navbar-header">
              <button type="button" class="navbar-toggle" title="toggle navbar" data-toggle="collapse" data-target=".navbar-collapse">
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
              </button>
              <a class="navbar-brand" href="http://www.shinayoshi.net//">shinayoshi&#39;s note</a>
            </div>
            <div class="navbar-collapse collapse">
              <ul class="nav navbar-nav">
                <li><a href="http://www.shinayoshi.net//">Home</a></li>
                <li><a href="http://www.shinayoshi.net//post/">All posts</a></li>
              </ul>
              <ul class="nav navbar-nav navbar-right">
                
                <li>
                  <form class="search navbar-form navbar-right" role="search" action="https://www.google.com/search" method="GET">
                    <input type="hidden" name="sitesearch" value="www.shinayoshi.net" />
                    <div class="form-group">
                      <input type="text" class="form-control" placeholder="Search" name="q" />
                    </div>
                  </form>
                </li>
                
                <li>
                  <a class="subscribe-rss" href="http://www.shinayoshi.net/index.xml" title="subscribe via RSS">
                    <i class="fa fa-rss fa-lg"></i>
                  </a>
                </li>
              </ul>
            </div>
          </div>
        </nav>
      </header>


      <div id="main" role="main" class="container">
        <div id="content">
          <div class="row">
            <div class="page-content col-md-9">
              
              <article>
                <div class="title">
                  <h1><a href="http://www.shinayoshi.net/post/2016/08/20/installing-cacti-on-raspberrypi/">Raspbian(Jessie)にCactiをインストールする</a></h1>
                  <p>
                    <span class="label label-primary">Sat Aug 20, 2016</span> in
                    
                    
                    <a href="http://www.shinayoshi.net//categories/server">server</a>
                     using tags
                    
                    
                    <a href="http://www.shinayoshi.net//tags/raspberrypi">raspberrypi</a>
                    
                     , 
                    <a href="http://www.shinayoshi.net//tags/jessie">jessie</a>
                    
                     , 
                    <a href="http://www.shinayoshi.net//tags/cacti">cacti</a>
                    
                  </p>
                </div>
                <div class="contents">
                  

<p>Raspbian(Jessie)にCactiを導入するまでのメモです。
Apache2やMySQLはインストール済みであることを前提としています。</p>

<h2 id="cactiのインストール:2f489629b1913a89dc29f01f282bd186">Cactiのインストール</h2>

<p>Cactiをインストールする。
途中でApache2の設定やMySQLのパスワードについて聞かれるので適宜回答する。</p>

<pre><code>$ sudo apt-get install cacti cacti-spine

↓&lt;了解&gt;を選択してEnter
 ┌─────────────────────┤ libphp-adodb を設定しています ├─────────────────────┐
 │                                                                           │ 
 │ 警告: php に対するインクルードパスが変更されています!                     │ 
 │                                                                           │ 
 │ libphp-adobd は /usr/share/adodb にインストールされなくなっています。新   │ 
 │ しいインストールのパスは /usr/share/php/adodb です。                      │ 
 │                                                                           │ 
 │ php.ini ファイルを更新してください。web サーバの設定も変更する必要がある  │ 
 │ かもしれません。                                                          │ 
 │                                                                           │ 
 │                                  &lt;了解&gt;                                   │ 
 │                                                                           │ 
 └───────────────────────────────────────────────────────────────────────────┘ 

↓apache2を選択してEnter
 ┌────────────────────────┤ cacti を設定しています ├─────────────────────────┐
 │ Cacti が自動的に設定するウェブサーバを選んでください。                    │ 
 │                                                                           │ 
 │ ウェブサーバを手作業で設定したい場合は「どれでもない」を選んでください。  │ 
 │                                                                           │ 
 │ ウェブサーバ:                                                             │ 
 │                                                                           │ 
 │                               apache2                                     │ 
 │                               lighttpd                                    │ 
 │                               どれでもない                                │ 
 │                                                                           │ 
 │                                                                           │ 
 │                                  &lt;了解&gt;                                   │ 
 │                                                                           │ 
 └───────────────────────────────────────────────────────────────────────────┘ 

↓&lt;はい&gt;を選択してEnter
 ┌────────────────────────┤ cacti を設定しています ├─────────────────────────┐
 │                                                                           │ 
 │ cacti は利用できるようになる前にはデータベースをインストールして設定する  │ 
 │ 必要があります。この設定を dbconfig-common で管理するようにもできます。   │ 
 │                                                                           │ 
 │ あなたが熟練したデータベース管理者でこの設定について手動で何をするのかを  │ 
 │ 知っている場合、あるいはデータベースが既にインストール及び設定されている  │ 
 │ 場合は、この選択を選ばない方が良いでしょう。何をすればいいのかについての  │ 
 │ 詳細については、大抵 /usr/share/doc/cacti に置かれています。              │ 
 │                                                                           │ 
 │ そうでない場合は、恐らくこの設定を選ぶのが良いでしょう。                  │ 
 │                                                                           │ 
 │ cacti のデータベースを dbconfig-common で設定しますか?                    │ 
 │                                                                           │ 
 │                    &lt;はい&gt;                      &lt;いいえ&gt;                   │ 
 │                                                                           │ 
 └───────────────────────────────────────────────────────────────────────────┘ 

↓MySQLのrootユーザのパスワードを入力し、&lt;了解&gt;を選択してEnter
  ┌────────────────────────┤ cacti を設定しています ├────────────────────────┐
  │ このパッケージが MySQL データベースとユーザを作る際に使う管理者権限アカ  │ 
  │ ウントのパスワードを入力してください。                                   │ 
  │                                                                          │ 
  │ データベースの管理権限を持つユーザのパスワード:                          │ 
  │                                                                          │ 
  │ ________________________________________________________________________ │ 
  │                                                                          │ 
  │                   &lt;了解&gt;                     &lt;取消&gt;                      │ 
  │                                                                          │ 
  └──────────────────────────────────────────────────────────────────────────┘ 

↓MySQLのcactiユーザのパスワードを入力し、&lt;了解&gt;を選択してEnter
  ┌────────────────────────┤ cacti を設定しています ├────────────────────────┐
  │ データベースサーバに cacti が登録するパスワードを入力してください。空の  │ 
  │ ままにしておくと、ランダムパスワードが生成されます。                     │ 
  │                                                                          │ 
  │ cacti 用の MySQL アプリケーションパスワード:                             │ 
  │                                                                          │ 
  │ ________________________________________________________________________ │ 
  │                                                                          │ 
  │                   &lt;了解&gt;                     &lt;取消&gt;                      │ 
  │                                                                          │ 
  └──────────────────────────────────────────────────────────────────────────┘ 

</code></pre>

<p>データベースをMyISAMからInnoDBに変更する。</p>

<pre><code>$ cd /usr/share/cacti/cli
$ sudo php convert_innodb.php
Converting All Non-Memory Cacti Database Tables to Innodb with Less than '300000' Records
Converting Table -&gt; 'cdef' Successful
Converting Table -&gt; 'cdef_items' Successful
Converting Table -&gt; 'colors' Successful
Converting Table -&gt; 'data_input' Successful
Converting Table -&gt; 'data_input_data' Successful
Converting Table -&gt; 'data_input_fields' Successful
Converting Table -&gt; 'data_local' Successful
Converting Table -&gt; 'data_template' Successful
Converting Table -&gt; 'data_template_data' Successful
Converting Table -&gt; 'data_template_data_rra' Successful
Converting Table -&gt; 'data_template_rrd' Successful
Converting Table -&gt; 'graph_local' Successful
Converting Table -&gt; 'graph_template_input' Successful
Converting Table -&gt; 'graph_template_input_defs' Successful
Converting Table -&gt; 'graph_templates' Successful
Converting Table -&gt; 'graph_templates_gprint' Successful
Converting Table -&gt; 'graph_templates_graph' Successful
Converting Table -&gt; 'graph_templates_item' Successful
Converting Table -&gt; 'graph_tree' Successful
Converting Table -&gt; 'graph_tree_items' Successful
Converting Table -&gt; 'host' Successful
Converting Table -&gt; 'host_graph' Successful
Converting Table -&gt; 'host_snmp_cache' Successful
Converting Table -&gt; 'host_snmp_query' Successful
Converting Table -&gt; 'host_template' Successful
Converting Table -&gt; 'host_template_graph' Successful
Converting Table -&gt; 'host_template_snmp_query' Successful
Converting Table -&gt; 'plugin_config' Successful
Converting Table -&gt; 'plugin_db_changes' Successful
Converting Table -&gt; 'plugin_hooks' Successful
Converting Table -&gt; 'plugin_realms' Successful
Converting Table -&gt; 'poller' Successful
Converting Table -&gt; 'poller_command' Successful
Converting Table -&gt; 'poller_item' Successful
Converting Table -&gt; 'poller_output' Successful
Converting Table -&gt; 'poller_reindex' Successful
Converting Table -&gt; 'poller_time' Successful
Converting Table -&gt; 'rra' Successful
Converting Table -&gt; 'rra_cf' Successful
Converting Table -&gt; 'settings' Successful
Converting Table -&gt; 'settings_graphs' Successful
Converting Table -&gt; 'settings_tree' Successful
Converting Table -&gt; 'snmp_query' Successful
Converting Table -&gt; 'snmp_query_graph' Successful
Converting Table -&gt; 'snmp_query_graph_rrd' Successful
Converting Table -&gt; 'snmp_query_graph_rrd_sv' Successful
Converting Table -&gt; 'snmp_query_graph_sv' Successful
Converting Table -&gt; 'user_auth' Successful
Converting Table -&gt; 'user_auth_perms' Successful
Converting Table -&gt; 'user_auth_realm' Successful
Converting Table -&gt; 'user_log' Successful
Converting Table -&gt; 'version' Successful
$
</code></pre>

<h2 id="cactiへのアクセス:2f489629b1913a89dc29f01f282bd186">Cactiへのアクセス</h2>

<p>ブラウザからCactiのURL(<code>http://IPアドレス/cacti</code>)にアクセスする。</p>

<p>Cactiの初期設定画面が表示されるので、画面の指示に従いながら設定を行う。</p>

<p>↓Nextをクリック</p>

<p><img src="/img/20160820_01/cacti_install_01.png" alt="cacti_install_01" width="320px" /></p>

<p>↓Nextをクリック</p>

<p><img src="/img/20160820_01/cacti_install_02.png" alt="cacti_install_02" width="320px" /></p>

<p>↓Errorがないことを確認してFinishをクリック</p>

<p><img src="/img/20160820_01/cacti_install_03.png" alt="cacti_install_03" width="320px" /></p>

<p>↓admin/adminでログイン</p>

<p><img src="/img/20160820_01/cacti_install_04.png" alt="cacti_install_04" width="320px" /></p>

<p>↓adminの新しいパスワードを入力してSaveをクリック</p>

<p><img src="/img/20160820_01/cacti_install_05.png" alt="cacti_install_05" width="320px" /></p>

<p>↓ログイン後の初期画面</p>

<p><img src="/img/20160820_01/cacti_install_06.png" alt="cacti_install_06" width="320px" /></p>

<p>以上</p>

                </div>
              </article>
              
              <article>
                <div class="title">
                  <h1><a href="http://www.shinayoshi.net/post/2016/08/16/security-setting-on-cowrie/">Cowrieのセキュリティ設定</a></h1>
                  <p>
                    <span class="label label-primary">Tue Aug 16, 2016</span> in
                    
                    
                    <a href="http://www.shinayoshi.net//categories/server">server</a>
                     using tags
                    
                    
                    <a href="http://www.shinayoshi.net//tags/jessie">jessie</a>
                    
                     , 
                    <a href="http://www.shinayoshi.net//tags/cowrie">cowrie</a>
                    
                  </p>
                </div>
                <div class="contents">
                  

<p>前回まででCowrieのインストールやKippo-Graphでの可視化を行った。
Cowrieを使用するにあたり追加でやっておきたいセキュリティ設定をメモする。</p>

<h2 id="ipv6の無効化:fe15561ef667c99ac763e1e39b0b43c7">IPv6の無効化</h2>

<p>IPv6は使用しないため、IPv6を無効化する。</p>

<pre><code>$ sudo sysctl -w net.ipv6.conf.all.disable_ipv6=1
$ sudo sysctl -w net.ipv6.conf.default.disable_ipv6=1
$ sudo sysctl -a | grep disable_ipv6
</code></pre>

<p>再起動後もIPv6が無効化するように設定する。</p>

<pre><code>$ sudo vi /etc/sysctl.d/10-disableipv6.conf
net.ipv6.conf.all.disable_ipv6=1
net.ipv6.conf.default.disable_ipv6=1
</code></pre>

<h2 id="selinuxの無効化:fe15561ef667c99ac763e1e39b0b43c7">SELinuxの無効化</h2>

<p>Raspbian(Jessie)ではデフォルトでSELinuxが使えないようなので、特にやることなし。</p>

<h2 id="iptablesの設定:fe15561ef667c99ac763e1e39b0b43c7">iptablesの設定</h2>

<p>iptablesでfirewallを設定する。</p>

<pre><code>#Cowrieポートのポートフォワード(別手順で設定済み)
#$ sudo iptables -t nat -A PREROUTING -p tcp --dport 22 -j REDIRECT --to-port 2222

##INPUTチェーン
#IPスプーフィング対策
$ sudo iptables -A INPUT -p tcp --tcp-flags SYN,ACK SYN,ACK -m state --state NEW -j REJECT --reject-with tcp-reset

#セッションハイジャック対策
$ sudo iptables -A INPUT -p tcp ! --syn -m state --state NEW -j DROP

#不正なパケット拒否
$ sudo iptables -A INPUT -m state --state INVALID -j DROP

#内部からの通信を始めた場合のパケットは許可
$ sudo iptables -A INPUT -m state --state ESTABLISHED,RELATED -j ACCEPT

#ループバックからの通信は通す
$ sudo iptables -A INPUT -i lo -j ACCEPT

#ICMPパケットは許可
$ sudo iptables -A INPUT -p icmp -j ACCEPT

#DHCPクライアントとしてDHCPに必要な通信は通す
#$ sudo iptables -A INPUT -p udp --dport 67 --sport 68 -j ACCEPT

#SSH(20022/tcp)は許可(ローカルネットワークからの接続のみ許可)
$ sudo iptables -A INPUT -m state --state NEW -m tcp -p tcp -s 192.168.10.0/24 --dport 20022 -j ACCEPT

#HTTPは許可(ローカルネットワークからの接続のみ許可)
$ sudo iptables -A INPUT -m state --state NEW -m tcp -p tcp -s 192.168.10.0/24 --dport 80 -j ACCEPT

#Cowrieは許可(5回まで新規接続許可。それ以降は1分に1回に制限。10分間無接続なら制限解除)
$ sudo iptables -A INPUT -p tcp --dport 2222 -m state --state NEW -m hashlimit --hashlimit-name ssh_limit --hashlimit 1/m --hashlimit-burst 5 --hashlimit-mode srcip --hashlimit-htable-expire 600000 -j ACCEPT

#Zabbix-Agentへの通信は許可
$ sudo iptables -A INPUT -m state --state NEW -m tcp -p tcp -s 192.168.30.0/24 --dport 10050 -j ACCEPT

##OUTPUTチェーン
#ループバックへの通信は通す
$ sudo iptables -A OUTPUT -o lo -j ACCEPT

#ICMP応答のパケットは通す
$ sudo iptables -A OUTPUT -p icmp -m state --state ESTABLISHED,RELATED -j ACCEPT

#外部からの通信を始めた場合のパケットを許可
$ sudo iptables -A OUTPUT -m state --state ESTABLISHED,RELATED -j ACCEPT

#tcp-resetの通信は通す
$ sudo iptables -A OUTPUT -p tcp --tcp-flags FIN,SYN,RST RST -m state --state ESTABLISHED,RELATED -j ACCEPT

#DHCPクライアントとしてDHCPに必要な通信は通す
#$ sudo iptables -A OUTPUT -p udp --dport 68 --sport 67 -j ACCEPT

#ユーザrootが発したパケットは許可
$ sudo iptables -A OUTPUT -m owner --uid-owner 0 -j ACCEPT

#NTPは許可
$ sudo iptables -A OUTPUT -m state --state NEW -m udp -p udp --dport 123 -j ACCEPT

#Zabbix-Serverへの通信は許可
$ sudo iptables -A OUTPUT -m state --state NEW -m tcp -p tcp -d 192.168.30.0/24 --dport 10051 -j ACCEPT

#外部からの通信は拒否。外部への通信も拒否。
$ sudo iptables -P INPUT DROP
$ sudo iptables -P FORWARD DROP
$ sudo iptables -P OUTPUT DROP
</code></pre>

<p>iptablesの設定を保存する。</p>

<pre><code>$ sudo sh -c &quot;iptables-save &gt; /etc/iptables/rules.v4&quot;
</code></pre>

<ul>
<li><a href="http://techracho.bpsinc.jp/yamasita-taisuke/2013_05_01/8351">iptablesで鉄壁？の守りを実現する3つのTips</a></li>
<li><a href="http://www.unix-power.net/linux/iptables.html">CentOS iptablesによるパケットフィルタ</a></li>
<li><a href="http://kassyjp.ninja-web.net/ras/jessie/iptables.htm">2.iptables（ファイアウォール）のセットアップ - RaspberryPiで各種サーバー作り！ - ある阪大生の物置小屋</a></li>
</ul>

<h2 id="ログ出力先をsyslogに変更:fe15561ef667c99ac763e1e39b0b43c7">ログ出力先をsyslogに変更</h2>

<p>twistdの作成するログは1000000MB程度でログローテートされてしまうため、Syslogに出力するように変更して日次でログローテートするように変更する。</p>

<p>ログ保管用のディレクトリ作成。</p>

<pre><code>$ sudo mkdir /var/log/cowrie
$ sudo chown cowrie:adm /var/log/cowrie/
</code></pre>

<p>rsyslogの設定。</p>

<pre><code>$ sudo vi /etc/rsyslog.d/cowrie.conf
if $programname == 'cowrie' then /var/log/cowrie/cowrie.log
&amp; ~
</code></pre>

<p>rsyslogの再起動。</p>

<pre><code>$ sudo systemctl restart rsyslog
</code></pre>

<p>Cowrieのログ出力先変更。</p>

<pre><code>$ sudo su - cowrie
$ cd ${COWRIE_INSTALL_DIR}
$ vi start.sh
$ diff ./start.sh.back20160818 ./start.sh
31c31
&lt;     twistd $XARGS -l log/cowrie.log --umask 0027 --pidfile cowrie.pid cowrie
---
&gt;     twistd $XARGS --syslog --prefix cowrie --umask 0027 --pidfile cowrie.pid cowrie
33c33
&lt;     authbind --deep twistd $XARGS -l log/cowrie.log --umask 0027 --pidfile cowrie.pid cowrie
---
&gt;     authbind --deep twistd $XARGS --syslog --prefix cowrie --umask 0027 --pidfile cowrie.pid cowrie
</code></pre>

<h2 id="logrotateの設定:fe15561ef667c99ac763e1e39b0b43c7">logrotateの設定</h2>

<p>logrotateをインストールする(通常はインストール済みのはず)。</p>

<pre><code>$ sudo apt-get install logrotate
</code></pre>

<p>Cowrie用のlogrotate設定を作成する。</p>

<pre><code>$ sudo vi /etc/logrotate.d/cowrie
/var/log/cowrie/cowrie.log
{
        daily
        rotate 92
        dateext
        create 0640 cowrie adm
        missingok
        ifempty
        compress
        postrotate
                invoke-rc.d rsyslog rotate &gt; /dev/null
        endscript
}
</code></pre>

<p>logrotateをテスト実行し、エラーがないことを確認する。</p>

<pre><code>$ sudo logrotate -d /etc/logrotate.d/cowrie
</code></pre>

<ul>
<li><a href="http://server-setting.info/centos/loglotation.html">ログローテーション(logrotate)を使ってみる ( httpd(apache)の設定例 ) | レンタルサーバー・自宅サーバー設定・構築のヒント</a></li>
<li><a href="https://open-groove.net/linux/logrotate-test/">logrotate（ログローテート）の動作確認 | OpenGroove</a></li>
</ul>

<h2 id="logwatchのインストール:fe15561ef667c99ac763e1e39b0b43c7">logwatchのインストール</h2>

<p>logwatchをインストールする。</p>

<pre><code>$ sudo apt-get install logwatch
</code></pre>

<p>logwatchの実行結果を確認する。</p>

<pre><code>$ sudo logwatch --output stdout
</code></pre>

<p>以上</p>

                </div>
              </article>
              
              <article>
                <div class="title">
                  <h1><a href="http://www.shinayoshi.net/post/2016/08/16/install-kippo-graph/">Kippo-GraphをインストールしてCowrieのログを可視化する</a></h1>
                  <p>
                    <span class="label label-primary">Tue Aug 16, 2016</span> in
                    
                    
                    <a href="http://www.shinayoshi.net//categories/server">server</a>
                     using tags
                    
                    
                    <a href="http://www.shinayoshi.net//tags/jessie">jessie</a>
                    
                     , 
                    <a href="http://www.shinayoshi.net//tags/cowrie">cowrie</a>
                    
                     , 
                    <a href="http://www.shinayoshi.net//tags/kippo-graph">kippo-graph</a>
                    
                  </p>
                </div>
                <div class="contents">
                  

<p>Kippo-Graphの公式(<a href="http://bruteforce.gr/kippo-graph">Kippo-Graph - BruteForce Lab&rsquo;s Blog</a>)を参考にKippo-Graphをインストールするまでのメモです。</p>

<h2 id="mysqlのインストールと初期設定:d89df975e87a1641818c282be53c7899">MySQLのインストールと初期設定</h2>

<p>MySQLをインストールする。</p>

<p>インストール途中でMySQLのrootアカウントのパスワードを求められるので、適宜設定する。</p>

<pre><code>$ sudo apt-get update
$ sudo apt-get install mysql-server
</code></pre>

<p>MySQLのセキュア設定</p>

<pre><code>$ mysql_secure_installation




NOTE: RUNNING ALL PARTS OF THIS SCRIPT IS RECOMMENDED FOR ALL MySQL
      SERVERS IN PRODUCTION USE!  PLEASE READ EACH STEP CAREFULLY!


In order to log into MySQL to secure it, we'll need the current
password for the root user.  If you've just installed MySQL, and
you haven't set the root password yet, the password will be blank,
so you should just press enter here.

Enter current password for root (enter for none): 
OK, successfully used password, moving on...

Setting the root password ensures that nobody can log into the MySQL
root user without the proper authorisation.

You already have a root password set, so you can safely answer 'n'.

Change the root password? [Y/n] n
 ... skipping.

By default, a MySQL installation has an anonymous user, allowing anyone
to log into MySQL without having to have a user account created for
them.  This is intended only for testing, and to make the installation
go a bit smoother.  You should remove them before moving into a
production environment.

Remove anonymous users? [Y/n] Y
 ... Success!

Normally, root should only be allowed to connect from 'localhost'.  This
ensures that someone cannot guess at the root password from the network.

Disallow root login remotely? [Y/n] Y
 ... Success!

By default, MySQL comes with a database named 'test' that anyone can
access.  This is also intended only for testing, and should be removed
before moving into a production environment.

Remove test database and access to it? [Y/n] Y
 - Dropping test database...
ERROR 1008 (HY000) at line 1: Can't drop database 'test'; database doesn't exist
 ... Failed!  Not critical, keep moving...
 - Removing privileges on test database...
 ... Success!

Reloading the privilege tables will ensure that all changes made so far
will take effect immediately.

Reload privilege tables now? [Y/n] Y
 ... Success!

Cleaning up...



All done!  If you've completed all of the above steps, your MySQL
installation should now be secure.

Thanks for using MySQL!
</code></pre>

<p>MySQLの初期設定</p>

<pre><code>$ sudo vi /etc/mysql/my.cnf
[mysqld]
character-set-server=utf8
collation-server=utf8_general_ci
skip-character-set-client-handshake
default-storage-engine=InnoDB
innodb_file_per_table
innodb_buffer_pool_size=256M
skip-name-resolve

[mysqldump]
default-character-set=utf8

[mysql]
default-character-set=utf8
</code></pre>

<ul>
<li><a href="https://dev.mysql.com/doc/refman/5.5/en/server-system-variables.html">MySQL :: MySQL 5.5 Reference Manual :: 5.1.4 Server System Variables</a></li>
</ul>

<p>MySQLの再起動</p>

<pre><code>$ sudo systemctl restart mysql
</code></pre>

<h2 id="cowrieのログ出力先を変更:d89df975e87a1641818c282be53c7899">Cowrieのログ出力先を変更</h2>

<p>Cowrie用データベースの作成</p>

<pre><code>$ mysql -uroot -p
Enter password:
mysql&gt; create database cowrie character set utf8 collate utf8_bin;
mysql&gt; grant all privileges on cowrie.* to cowrie@localhost identified by 'cowrie_password';
mysql&gt; quit

$ cd ${COWRIE_INSTALL_DIR}
$ cat doc/sql/mysql.sql | mysql -ucowrie -p cowrie
</code></pre>

<p>CowrieのログをMySQLのデータベースに出力する。</p>

<pre><code>$ cd ${COWRIE_INSTALL_DIR}
$ vi cowrie.cfg
↓コメントアウト
#[iutput_jsonloi]
#logfile = log/cowrie.json

#[output_mysql]
#host = localhost
#database = cowrie
#username = cowrie
#password = secret
#port = 3306
[output_mysql]
host = localhost
database = cowrie
username = cowrie
password = cowrie_password
port = 3306
</code></pre>

<p>Cowrieの再起動</p>

<pre><code>$ ./stop.sh
$ ./start.sh
</code></pre>

<h2 id="apache2のインストール:d89df975e87a1641818c282be53c7899">Apache2のインストール</h2>

<p>Apache2をインストールする。</p>

<pre><code>$ sudo apt-get install apache2
</code></pre>

<p>Apache2のセキュリティ設定。</p>

<pre><code>$ sudo vi /etc/apache2/conf-available/security.conf
ServerTokens Prod
ServerSignature Off
</code></pre>

<p>Apache2の文字コード設定。</p>

<pre><code>$ sudo vi /etc/apache2/conf-available/charset.conf
#AddDefaultCharset UTF-8
</code></pre>

<p>Apache2のServerName設定。</p>

<pre><code>$ sudo sh -c &quot;echo ServerName ${HOSTNAME} &gt; /etc/apache2/conf-available/fqdn.conf&quot;
$ sudo a2enconf fqdn
</code></pre>

<p>Apache2の再起動。</p>

<pre><code>$ sudo apachectl configtest
$ sudo systemctl restart apache2
</code></pre>

<h2 id="kippo-graphのインストール:d89df975e87a1641818c282be53c7899">Kippo-Graphのインストール</h2>

<p>関連パッケージのインストール。</p>

<pre><code>$ sudo apt-get install libapache2-mod-php5 php5-mysql php5-gd php5-curl
$ sudo apt-get install dnsutils
$ sudo systemctl restart apache2
</code></pre>

<p>Kippo-Graphのインストール。</p>

<pre><code>$ wget http://bruteforce.gr/wp-content/uploads/kippo-graph-1.5.1.tar.gz
$ sudo tar zxvf kippo-graph-1.5.1.tar.gz -C /usr/share
$ sudo vi /etc/apache2/conf-available/kippo-graph.conf
&lt;IfModule mod_alias.c&gt;
    Alias /kippo-graph /usr/share/kippo-graph-1.5.1
&lt;/IfModule&gt;
$ sudo a2enconf kippo-graph
$ sudo apachectl configtest
$ sudo systemctl restart apache2
</code></pre>

<p>Kippo-Graphの設定。</p>

<pre><code>$ sudo chmod 777 /usr/share/kippo-graph-1.5.1/generated-graphs/
$ sudo cp -p /usr/share/kippo-graph-1.5.1/config.php.dist /usr/share/kippo-graph-1.5.1/config.php
$ sudo vi /usr/share/kippo-graph-1.5.1/config.php
define('DB_HOST', 'localhost');
define('DB_USER', 'cowrie');
define('DB_PASS', 'cowrie_password');
define('DB_NAME', 'cowrie');
define('DB_PORT', '3306');
</code></pre>

<h2 id="kippo-graphの修正:d89df975e87a1641818c282be53c7899">Kippo-Graphの修正</h2>

<p>KippoとCowrieのデータベースのテーブル構造の違いにより一部動かない機能(KIPPO-PLAYLOG)があった。</p>

<p>PLAYLOGを再生するために以下のファイルを修正。一応、PLAYLOGが再生できるようになったが、他の部分に影響がないかは不明。。。試すとしても自己責任でお願いします。</p>

<p><code>class/KippoPlayLog.class.php</code>の修正</p>

<pre><code>$ cd /usr/share/kippo-graph-1.5.1
$ sudo cp -p class/KippoPlayLog.class.php class/KippoPlayLog.class.php.org
$ sudo vi class/KippoPlayLog.class.php
$ diff class/KippoPlayLog.class.php.org class/KippoPlayLog.class.php
21c21
&lt;             SELECT ttylog.session, timestamp, ROUND(LENGTH(ttylog)/1024, 2) AS size
---
&gt;             SELECT ttylog.session, timestamp, ROUND(size/1024, 2) AS size
</code></pre>

<p><code>include/play.php</code>の修正</p>

<pre><code>$ cd /usr/share/kippo-graph-1.5.1
$ sudo cp -p include/play.php include/play.php.org
$ sudo vi include/play.php
$ diff play.php.org play.php
70c70
&lt;                 $log = base64_encode($row['ttylog']);
---
&gt;                 $log = base64_encode(file_get_contents($row['ttylog']));
</code></pre>

<p>ttylogへのシンボリックリンク作成</p>

<pre><code>$ cd /usr/share/kippo-graph-1.5.1/include
$ sudo ln -s ${COWRIE_INSTALL_DIR}/log/ log
$ sudo chgrp www-data /home/cowrie/cowrie/log/tty/
$ sudo chmod g+s /home/cowrie/cowrie/log/tty/
</code></pre>

<p>Cowrie起動スクリプトの修正</p>

<pre><code>$ sudo su - cowrie
$ cd ${COWRIE_INSTALL_DIR}/
$ cp -p start.sh start.sh.org
$ vi start.sh
$ diff start.sh.org start.sh
31c31
&lt;     twistd $XARGS -l log/cowrie.log --umask 0077 --pidfile cowrie.pid cowrie
---
&gt;     twistd $XARGS -l log/cowrie.log --umask 0027 --pidfile cowrie.pid cowrie
33c33
&lt;     authbind --deep twistd $XARGS -l log/cowrie.log --umask 0077 --pidfile cowrie.pid cowrie
---
&gt;     authbind --deep twistd $XARGS -l log/cowrie.log --umask 0027 --pidfile cowrie.pid cowrie
</code></pre>

<p>Cowrieの再起動</p>

<pre><code>$ ./stop.sh
$ ./start.sh
</code></pre>

<p>以上</p>

                </div>
              </article>
              
              <article>
                <div class="title">
                  <h1><a href="http://www.shinayoshi.net/post/2016/08/15/install-cowrie-on-raspbian/">Raspbian(Jessie)にCowrieをインストールする</a></h1>
                  <p>
                    <span class="label label-primary">Mon Aug 15, 2016</span> in
                    
                    
                    <a href="http://www.shinayoshi.net//categories/server">server</a>
                     using tags
                    
                    
                    <a href="http://www.shinayoshi.net//tags/raspberrypi">raspberrypi</a>
                    
                     , 
                    <a href="http://www.shinayoshi.net//tags/jessie">jessie</a>
                    
                     , 
                    <a href="http://www.shinayoshi.net//tags/cowrie">cowrie</a>
                    
                  </p>
                </div>
                <div class="contents">
                  

<p>Raspbian(jessie)にCowrieをインストールしてSSHハニーポットを構築するメモです。
はじめはKippoを使用する予定だったのですが、Kippoの改良版であるCowrieを使用することにしました。</p>

<p>個人のメモですので、もし本メモを参考にハニーポットを構築する際は自己責任でお願いします。</p>

<h2 id="raspbianの初期設定:4c0925631b42437e2f8c229197506152">Raspbianの初期設定</h2>

<p>Raspbianの初期設定として以下を行いました。</p>

<h3 id="パッケージの最新化:4c0925631b42437e2f8c229197506152">パッケージの最新化</h3>

<pre><code>$ sudo apt-get update
$ sudo apt-get upgrade
</code></pre>

<h3 id="ipアドレスの固定化:4c0925631b42437e2f8c229197506152">IPアドレスの固定化</h3>

<pre><code>$ sudo vi /etc/dhcpcd.conf
#Add the following line
interface eth0
static ip_address=192.168.10.10/24
static routers=192.168.10.254
static domain_name_servers=192.168.100.1
#static domain_name=
#static domain_search=
</code></pre>

<h3 id="ntp設定:4c0925631b42437e2f8c229197506152">NTP設定</h3>

<p>NTP同期先を設定する。</p>

<pre><code>$ sudo vi /etc/ntp.conf
#Add the line
server ntp.nict.jp iburst
server ntp.jst.mfeed.ad.jp iburst
# comment out
#server 0.debian.pool.ntp.org iburst
#server 1.debian.pool.ntp.org iburst
#server 2.debian.pool.ntp.org iburst
#server 3.debian.pool.ntp.org iburst
</code></pre>

<p>NTPサーバを再起動する。</p>

<pre><code>$ sudo systemctl restart ntp
</code></pre>

<p>時刻同期の状態を確認する。</p>

<pre><code>$ ntpq -p
</code></pre>

<h3 id="raspi-config関連:4c0925631b42437e2f8c229197506152">raspi-config関連</h3>

<pre><code>$ sudo raspi-config
</code></pre>

<ul>
<li>ディスク拡張</li>
<li>文字コード設定</li>
<li>タイムゾーン設定</li>
<li>Wifiの国設定</li>
<li>ホスト名変更</li>
</ul>

<h2 id="公開鍵認証方式の設定:4c0925631b42437e2f8c229197506152">公開鍵認証方式の設定</h2>

<pre><code>$ ssh-keygen -t rsa
Generating public/private rsa key pair.
Enter file in which to save the key (/home/pi/.ssh/id_rsa): 
Created directory '/home/pi/.ssh'.
Enter passphrase (empty for no passphrase): 
Enter same passphrase again: 
Your identification has been saved in /home/pi/.ssh/id_rsa.
Your public key has been saved in /home/pi/.ssh/id_rsa.pub.

$ cd ~/.ssh/
$ cat id_rsa.pub &gt;&gt; authorized_keys
$ chmod 600 authorized_keys
</code></pre>

<p>Raspbianで作成した秘密鍵をローカルPCにコピーする。</p>

<pre><code>$ scp pi@192.168.10.10:~/.ssh/id_rsa ~/.ssh/
</code></pre>

<p>公開鍵認証方式でsshログインできることを確認する。</p>

<pre><code>$ ssh -i ~/.ssh/id_rsa pi@192.168.10.10
</code></pre>

<h2 id="sshサーバの設定:4c0925631b42437e2f8c229197506152">SSHサーバの設定</h2>

<p>Cowrieで<code>22/tcp</code>を使用しているため、SSHサーバのポートを変更します。またログイン設定も変更します。</p>

<pre><code>$ sudo vi /etc/ssh/sshd_config
#Port 22
Port 20022

#PermitRootLogin without-password
PermitRootLogin no

ChallengeResponseAuthentication no

#PasswordAuthentication yes
PasswordAuthentication no
</code></pre>

<p>SSHサーバの設定を再起動する。</p>

<pre><code>$ sudo systemctl restart ssh
</code></pre>

<p>SSHサーバのポートを変更しているため、以降の手順でSSHログインするためにはポート番号を指定する。</p>

<pre><code>$ ssh -i ~/.ssh/id_rsa -p 20022 pi@192.168.10.10
</code></pre>

<h2 id="ユーザ設定:4c0925631b42437e2f8c229197506152">ユーザ設定</h2>

<p>rootユーザが無効化されていることを確認する(2列目が<code>L</code>であることを確認)。</p>

<pre><code>$ sudo passwd -S root
root L 05/27/2016 0 99999 7 -1
</code></pre>

<p>Cowrieユーザを作成する。</p>

<pre><code>$ sudo adduser --disabled-password cowrie
ユーザ `cowrie' を追加しています...
新しいグループ `cowrie' (1001) を追加しています...
新しいユーザ `cowrie' (1001) をグループ `cowrie' として追加しています...
ホームディレクトリ `/home/cowrie' を作成しています...
`/etc/skel' からファイルをコピーしています...
cowrie のユーザ情報を変更中
新しい値を入力してください。標準設定値を使うならリターンを押してください
	フルネーム []: 
	部屋番号 []: 
	職場電話番号 []: 
	自宅電話番号 []: 
	その他 []: 
以上で正しいですか? [Y/n] y
</code></pre>

<h2 id="cowrieのインストール:4c0925631b42437e2f8c229197506152">Cowrieのインストール</h2>

<p>Cowrienの公式サイトの<a href="https://github.com/micheloosterhof/cowrie/blob/master/INSTALL.md">INSTALL.md</a>を参考にインストールを行う。</p>

<pre><code>$ sudo apt-get install python-twisted python-crypto python-pyasn1 python-gmpy2 python-mysqldb python-zope.interface

$ sudo su - cowrie
$ git clone http://github.com/micheloosterhof/cowrie
$ cd cowrie/
$ cp cowrie.cfg.dist cowrie.cfg
</code></pre>

<h2 id="cowrieの設定:4c0925631b42437e2f8c229197506152">Cowrieの設定</h2>

<pre><code>$ vi cowrie.cfg
#sensor_name=myhostname
sensor_name=rpicowrie

#hostname = svr04
hostname = cowrie01
</code></pre>

<h2 id="cowrieの起動と終了:4c0925631b42437e2f8c229197506152">Cowrieの起動と終了</h2>

<p>起動するときは以下のコマンドを実行する。</p>

<pre><code>$ ./start.sh
</code></pre>

<p>終了するときは以下のコマンドを実行する。</p>

<pre><code>$ ./stop.sh
</code></pre>

<h2 id="cowrieポートのポートフォワード:4c0925631b42437e2f8c229197506152">Cowrieポートのポートフォワード</h2>

<p>Cowrieでは<code>2222/tcp</code>でポート待ち受けをしているため、iptablesで22/tcpにポートフォワードする。</p>

<pre><code>$ sudo iptables -t nat -A PREROUTING -p tcp --dport 22 -j REDIRECT --to-port 2222
$ sudo iptables -t nat -n -L
</code></pre>

<h2 id="iptables設定の保存:4c0925631b42437e2f8c229197506152">iptables設定の保存</h2>

<p>再起動時にもポートフォワード設定が有効になるようにiptablesの設定を保存する。</p>

<pre><code>$ sudo apt-get install iptables-persistent
$ sudo systemctl enable netfilter-persistent
</code></pre>

<p>以上</p>

                </div>
              </article>
              
              <article>
                <div class="title">
                  <h1><a href="http://www.shinayoshi.net/post/2016/08/13/add-fortigate-mib-on-raspbian/">Raspbian(Jessie)にFortiGateのプライベートMIBを追加する</a></h1>
                  <p>
                    <span class="label label-primary">Sat Aug 13, 2016</span> in
                    
                    
                    <a href="http://www.shinayoshi.net//categories/server">server</a>
                     using tags
                    
                    
                    <a href="http://www.shinayoshi.net//tags/raspberrypi">raspberrypi</a>
                    
                     , 
                    <a href="http://www.shinayoshi.net//tags/jessie">jessie</a>
                    
                     , 
                    <a href="http://www.shinayoshi.net//tags/fgt-60d">FGT-60D</a>
                    
                  </p>
                </div>
                <div class="contents">
                  

<p>Raspbian(Jessie)にFortiGateのプライベートMIBを追加するまでのメモです。</p>

<h2 id="mibファイルのアップロード:7017348ad71b7a4303759dd4acee2115">MIBファイルのアップロード</h2>

<p>FortiGateのプライベートMIB(<code>FORTINET-CORE-MIB.mib</code>、<code>FORTINET-FORTIGATE-MIB.mib</code>)を<code>/home/pi</code>直下にアップロードします。</p>

<h2 id="プライベートmibの設定:7017348ad71b7a4303759dd4acee2115">プライベートMIBの設定</h2>

<p>プライベートMIBファイルを<code>/usr/share/snmp/mibs/vendor</code>に移動する。</p>

<pre><code>$ sudo mkdir /usr/share/snmp/mibs/vendor
$ sudo mv FORTINET-* /usr/share/snmp/mibs/vendor/
$ sudo chown root:root /usr/share/snmp/mibs/vendor/FORTINET-*
</code></pre>

<p>プライベートMIBを使用するように<code>snmp.conf</code>を設定する。</p>

<pre><code>$ sudo vi /etc/snmp/snmp.conf
mibdirs +/usr/share/snmp/mibs/vendor
mibs +FORTINET-CORE-MIB:FORTINET-FORTIGATE-MIB
</code></pre>

<h2 id="プライベートmibの設定確認:7017348ad71b7a4303759dd4acee2115">プライベートMIBの設定確認</h2>

<p>FortiGateのMIBフィールド名が表示されることを確認する。</p>

<pre><code>$ snmpwalk -v 2c -c public 192.168.1.1 .1.3.6.1.4.1.12356.101.4.1.4
FORTINET-FORTIGATE-MIB::fgSysMemUsage.0 = Gauge32: 29
</code></pre>

<p>以上</p>

                </div>
              </article>
              
              <article>
                <div class="title">
                  <h1><a href="http://www.shinayoshi.net/post/2016/08/11/monitoring-snmp-devices-on-zabbix/">ZabbixでSNMPデバイスの監視を行う</a></h1>
                  <p>
                    <span class="label label-primary">Thu Aug 11, 2016</span> in
                    
                    
                    <a href="http://www.shinayoshi.net//categories/server">server</a>
                     using tags
                    
                    
                    <a href="http://www.shinayoshi.net//tags/raspberrypi">raspberrypi</a>
                    
                     , 
                    <a href="http://www.shinayoshi.net//tags/jessie">jessie</a>
                    
                     , 
                    <a href="http://www.shinayoshi.net//tags/zabbix">zabbix</a>
                    
                  </p>
                </div>
                <div class="contents">
                  

<p>Raspbian(Jessie)にインストールしたZabbixでSNMPデバイスの監視を行うまでのメモです。</p>

<p>とりあえずSNMP Deviceの監視ができるようになりましたが、なぜこの手順でよいのか理解できていない部分が多いです。</p>

<h2 id="パッケージの更新:f5404dafe03c7d830d1b17663408aefc">パッケージの更新</h2>

<p>Zabbix Serverのパッケージを最新する。</p>

<pre><code>$ sudo apt-get update
$ sudo apt-get upgrade
</code></pre>

<h2 id="snmp関連パッケージのインストール:f5404dafe03c7d830d1b17663408aefc">SNMP関連パッケージのインストール</h2>

<p>Zabbix ServerにSNMP関連のパッケージをインストールする。</p>

<pre><code>$ sudo apt-get install snmp snmp-mibs-downloader
</code></pre>

<!-- $ sudo apt-get install snmpd -->

<!-- $ sudo apt-get install snmptrapd snmptt -->

<h2 id="snmpの設定:f5404dafe03c7d830d1b17663408aefc">SNMPの設定</h2>

<p><code>/usr/bin/download-mibs</code>でダウンロードしたMIBSを読み込めるように設定する。</p>

<pre><code>$ sudo vi /etc/snmp/snmp.conf
#mibs :
</code></pre>

<p>メモ：デフォルトでは以下のディレクトリを検索する。<code>snmpstatus --help</code>の出力で確認。</p>

<pre><code>${HOME}/.snmp/mibs
/usr/share/snmp/mibs
/usr/share/snmp/mibs/iana
/usr/share/snmp/mibs/ietf
/usr/share/mibs/site
/usr/share/snmp/mibs
/usr/share/mibs/iana
/usr/share/mibs/ietf
/usr/share/mibs/netsnmp
</code></pre>

<h2 id="zabbix-serverの再起動:f5404dafe03c7d830d1b17663408aefc">Zabbix Serverの再起動</h2>

<p>Zabbix Serverを再起動してSNMPの設定を読み込む(本当に必要？)。</p>

<pre><code>$ sudo systemctl restart zabbix-server
</code></pre>

<h2 id="zabbix-serverでのsnmp-device監視設定:f5404dafe03c7d830d1b17663408aefc">Zabbix ServerでのSNMP Device監視設定</h2>

<p>ブラウザからZabbix ServerのURL(<code>http://IPアドレス/zabbix</code>)にアクセスしてログインする。</p>

<p>「設定」⇒「ホスト」⇒「ホストの作成」を選択する。</p>

<p>ホストの設定画面が表示されるので最低限以下を設定する。</p>

<p>&ldquo;ホスト&rdquo;タブ</p>

<ul>
<li>ホスト名：監視対象機器のホスト名。</li>
<li>グループ：所属するグループ。適切なグループがなければ新規作成。</li>
<li>エージェントのインターフェース：削除。</li>
<li>SNMPインターフェース：追加。監視対象機器のIPアドレスを設定。</li>
</ul>

<p>&ldquo;テンプレート&rdquo;タブ</p>

<ul>
<li>テンプレートとのリンク：&rdquo;Template SNMP Device&rdquo;を追加。</li>
</ul>

<p>&ldquo;マクロ&rdquo;タブ</p>

<ul>
<li>マクロ：<code>{$SNMP_COMMUNITY}</code> ⇒ 値：<code>監視対象機器のコミュニティ名</code></li>
</ul>

<p>以上</p>

                </div>
              </article>
              
              <article>
                <div class="title">
                  <h1><a href="http://www.shinayoshi.net/post/2016/08/11/install-zabbix-agent-on-raspbian/">Raspbian(Jessie)にZabbix Agentをインストール</a></h1>
                  <p>
                    <span class="label label-primary">Thu Aug 11, 2016</span> in
                    
                    
                    <a href="http://www.shinayoshi.net//categories/server">server</a>
                     using tags
                    
                    
                    <a href="http://www.shinayoshi.net//tags/raspberrypi">raspberrypi</a>
                    
                     , 
                    <a href="http://www.shinayoshi.net//tags/jessie">jessie</a>
                    
                     , 
                    <a href="http://www.shinayoshi.net//tags/zabbix">zabbix</a>
                    
                  </p>
                </div>
                <div class="contents">
                  

<p>Raspbian(Jessie)にZabbix Agentをインストールしてサーバ監視を行うまでのメモです。
Zabbix Serverのインストールは別のメモになります。</p>

<h2 id="パッケージの更新:235ab9bc7c5a5e6a7bcc83bc43bc05a7">パッケージの更新</h2>

<p>Raspbianのパッケージを最新する。</p>

<pre><code>$ sudo apt-get update
$ sudo apt-get upgrade
</code></pre>

<h2 id="zabbix-agentのインストール:235ab9bc7c5a5e6a7bcc83bc43bc05a7">Zabbix Agentのインストール</h2>

<p>Zabbix Agentのインストール</p>

<pre><code>$ sudo apt-get install zabbix-agent
</code></pre>

<h2 id="zabbix-agentの設定:235ab9bc7c5a5e6a7bcc83bc43bc05a7">Zabbix Agentの設定</h2>

<p>Zabbix Agentを設定する。</p>

<pre><code>$ sudo vi /etc/zabbix/zabbix_agentd.conf
Server=(Zabbix server IP address)
ServerActive=(Zabbix server IP address)
Hostname=(Hostname)

$ sudo systemctl restart zabbix-agent
</code></pre>

<h2 id="zabbix-serverでの監視登録:235ab9bc7c5a5e6a7bcc83bc43bc05a7">Zabbix Serverでの監視登録</h2>

<p>ブラウザからZabbix ServerのURL(<code>http://IPアドレス/zabbix</code>)にアクセスしてログインする。</p>

<p>「設定」⇒「ホスト」⇒「ホストの作成」を選択する。</p>

<p>ホスト名の設定やテンプレートの選択を行い、保存を選択する。</p>

<p>以上</p>

                </div>
              </article>
              
              <article>
                <div class="title">
                  <h1><a href="http://www.shinayoshi.net/post/2016/08/10/install-zabbix-server-on-raspbian/">Raspbian(Jessie)にZabbix Serverをインストール</a></h1>
                  <p>
                    <span class="label label-primary">Wed Aug 10, 2016</span> in
                    
                    
                    <a href="http://www.shinayoshi.net//categories/server">server</a>
                     using tags
                    
                    
                    <a href="http://www.shinayoshi.net//tags/raspberrypi">raspberrypi</a>
                    
                     , 
                    <a href="http://www.shinayoshi.net//tags/jessie">jessie</a>
                    
                     , 
                    <a href="http://www.shinayoshi.net//tags/zabbix">zabbix</a>
                    
                  </p>
                </div>
                <div class="contents">
                  

<p>Raspbian(Jessie)にZabbix Serverをインストールするメモです。
Zabbix Agentのインストールは別のメモになります。</p>

<ul>
<li><a href="https://www.zabbix.com/documentation/2.2/manual/installation/install_from_packages">3 Installation from packages [Zabbix Documentation 2.2]</a></li>
</ul>

<h2 id="パッケージの更新:4df21ad0746a34acfa37879eaf637713">パッケージの更新</h2>

<p>Raspbianのパッケージを最新する。</p>

<pre><code>$ sudo apt-get update
$ sudo apt-get upgrade
</code></pre>

<h2 id="zabbix-serverのインストール:4df21ad0746a34acfa37879eaf637713">Zabbix Serverのインストール</h2>

<p>Zabbix Serverのインストール</p>

<p>インストール途中でMySQLのrootアカウントのパスワードを求められるので、適宜設定する。</p>

<pre><code>$ sudo apt-get install zabbix-server-mysql zabbix-frontend-php
$ sudo apt-get install php5-mysql
$ sudo apt-get install task-japanese
</code></pre>

<h3 id="mysqlの初期設定:4df21ad0746a34acfa37879eaf637713">MySQLの初期設定</h3>

<p>MySQLのセキュア設定</p>

<pre><code>$ mysql_secure_installation
In order to log into MySQL to secure it, we'll need the current
password for the root user.  If you've just installed MySQL, and
you haven't set the root password yet, the password will be blank,
so you should just press enter here.

Enter current password for root (enter for none): 
OK, successfully used password, moving on...

Setting the root password ensures that nobody can log into the MySQL
root user without the proper authorisation.

You already have a root password set, so you can safely answer 'n'.

Change the root password? [Y/n] n
 ... skipping.

By default, a MySQL installation has an anonymous user, allowing anyone
to log into MySQL without having to have a user account created for
them.  This is intended only for testing, and to make the installation
go a bit smoother.  You should remove them before moving into a
production environment.

Remove anonymous users? [Y/n] Y
 ... Success!

Normally, root should only be allowed to connect from 'localhost'.  This
ensures that someone cannot guess at the root password from the network.

Disallow root login remotely? [Y/n] Y
 ... Success!

By default, MySQL comes with a database named 'test' that anyone can
access.  This is also intended only for testing, and should be removed
before moving into a production environment.

Remove test database and access to it? [Y/n] Y
 - Dropping test database...
ERROR 1008 (HY000) at line 1: Can't drop database 'test'; database doesn't exist
 ... Failed!  Not critical, keep moving...
 - Removing privileges on test database...
 ... Success!

Reloading the privilege tables will ensure that all changes made so far
will take effect immediately.

Reload privilege tables now? [Y/n] Y
 ... Success!

Cleaning up...



All done!  If you've completed all of the above steps, your MySQL
installation should now be secure.

Thanks for using MySQL!
</code></pre>

<p>MySQLの初期設定</p>

<pre><code>$ sudo vi /etc/mysql/my.cnf
[mysqld]
character-set-server=utf8
collation-server=utf8_general_ci
skip-character-set-client-handshake
default-storage-engine=InnoDB
innodb_file_per_table
innodb_buffer_pool_size=256M
skip-name-resolve

[mysqldump]
default-character-set=utf8

[mysql]
default-character-set=utf8
</code></pre>

<ul>
<li><a href="https://dev.mysql.com/doc/refman/5.5/en/server-system-variables.html">MySQL :: MySQL 5.5 Reference Manual :: 5.1.4 Server System Variables</a></li>
</ul>

<p>MySQLの再起動</p>

<pre><code>$ sudo systemctl restart mysql
</code></pre>

<h3 id="apache2の初期設定:4df21ad0746a34acfa37879eaf637713">Apache2の初期設定</h3>

<p>Apache2のセキュリティ設定</p>

<pre><code>$ sudo vi /etc/apache2/conf-available/security.conf
ServerTokens Prod
ServerSignature Off
</code></pre>

<p>Apache2の文字コード設定</p>

<pre><code>$ sudo vi /etc/apache2/conf-available/charset.conf
#AddDefaultCharset UTF-8
</code></pre>

<p>Apache2のServerName設定</p>

<pre><code>$ sudo sh -c &quot;echo ServerName ${HOSTNAME} &gt; /etc/apache2/conf-available/fqdn.conf&quot;
$ sudo a2enconf fqdn
</code></pre>

<p>Apache2の再起動</p>

<pre><code>$ sudo apachectl configtest
$ sudo systemctl restart apache2
</code></pre>

<ul>
<li><a href="http://mk-55.hatenablog.com/entry/2014/07/07/004510">ubuntuにおけるapache2のAH00558エラーを解決する。 - mk_55&rsquo;s diary</a></li>
</ul>

<h2 id="zabbix-serverの設定:4df21ad0746a34acfa37879eaf637713">Zabbix Serverの設定</h2>

<p>データベースの作成</p>

<pre><code>$ mysql -uroot -p
Enter password:
mysql&gt; 
mysql&gt; create database zabbix character set utf8 collate utf8_bin;
mysql&gt; grant all privileges on zabbix.* to zabbix@localhost identified by 'zabbix_password';
mysql&gt; quit

$ zcat /usr/share/zabbix-server-mysql/schema.sql.gz | mysql -uzabbix -p zabbix
$ zcat /usr/share/zabbix-server-mysql/images.sql.gz | mysql -uzabbix -p zabbix
$ zcat /usr/share/zabbix-server-mysql/data.sql.gz | mysql -uzabbix -p zabbix
</code></pre>

<p>Apache2のZabbixサイト設定</p>

<pre><code>$ sudo cp /usr/share/doc/zabbix-frontend-php/examples/apache.conf /etc/apache2/conf-available/zabbix.conf
$ sudo vi /etc/apache2/conf-available/zabbix.conf
# Add the following lines
php_value max_execution_time 300
php_value memory_limit 128M
php_value post_max_size 16M
php_value upload_max_filesize 2M
php_value max_input_time 300
php_value date.timezone Asia/Tokyo

$ sudo a2enconf zabbix
$ sudo apachectl configtest
$ sudo systemctl restart apache2
</code></pre>

<p>Zabbixのサーバ設定</p>

<pre><code>$ sudo vi /etc/zabbix/zabbix_server.conf
DBHost=localhost
DBName=zabbix
DBUser=zabbix
DBPassword=zabbix_password

$ sudo vi /etc/default/zabbix-server
START=yes

$ sudo ln -s /usr/share/fonts/truetype/unifont/unifont.ttf /usr/share/zabbix/fonts/
$ sudo vi /usr/share/zabbix/include/defines.inc.php
define('ZBX_GRAPH_FONT_NAME',		'unifont');

$ sudo systemctl restart zabbix-server
</code></pre>

<h2 id="zabbix-serverへのアクセス:4df21ad0746a34acfa37879eaf637713">Zabbix Serverへのアクセス</h2>

<p>ブラウザからZabbix ServerのURL(<code>http://IPアドレス/zabbix</code>)にアクセスする。</p>

<p>Zabbixの初期設定画面が表示されるので、画面の指示に従いながら設定を行う。</p>

<h2 id="zabbix-serverへのログイン:4df21ad0746a34acfa37879eaf637713">Zabbix Serverへのログイン</h2>

<p>Zabbixの初期設定が完了するとログイン画面が表示されるので、デフォルトアカウント(<code>Admin/zabbix</code>)でログインする。
ログイン後は画面右上のProfileを開き、パスワードを変更しておく。</p>

<p>以上</p>

                </div>
              </article>
              
              <article>
                <div class="title">
                  <h1><a href="http://www.shinayoshi.net/post/2016/08/07/backup-raspbian/">Raspbianをバックアップ・リストアする</a></h1>
                  <p>
                    <span class="label label-primary">Sun Aug 7, 2016</span> in
                    
                    
                    <a href="http://www.shinayoshi.net//categories/server">server</a>
                     using tags
                    
                    
                    <a href="http://www.shinayoshi.net//tags/raspberrypi">raspberrypi</a>
                    
                     , 
                    <a href="http://www.shinayoshi.net//tags/backup">backup</a>
                    
                  </p>
                </div>
                <div class="contents">
                  

<p>RaspbianをSDカード丸ごとバックアップ・リストアするメモです。
今回はddコマンドを使ってディスクイメージを書き出す方法でバックアップ・リストアを行います。</p>

<h2 id="バックアップ:6cd0cb3f4c453418b61672dbcf967693">バックアップ</h2>

<p>SDカードデバイスを確認する。</p>

<pre><code>$ diskutil list
/dev/disk1
   #:                       TYPE NAME                    SIZE       IDENTIFIER
   0:     FDisk_partition_scheme                        *32.2 GB    disk1
   1:             Windows_FAT_32 boot                    66.1 MB    disk1s1
   2:                      Linux                         32.2 GB    disk1s2
</code></pre>

<p>SDカードデバイスをアンマウントする。</p>

<pre><code>$ diskutil unmountDisk /dev/disk1
Unmount of all volumes on disk1 was successful
</code></pre>

<p>SDカードのディスクイメージをバックアップする。</p>

<pre><code>$ sudo dd bs=1m if=/dev/rdisk1 of=~/Desktop/raspi_backup.img
Password:
30735+0 records in
30735+0 records out
32227983360 bytes transferred in 1610.088954 secs (20016275 bytes/sec)
</code></pre>

<p>SDカードデバイスを取り出す。</p>

<pre><code>$ diskutil eject /dev/disk1
Disk /dev/disk1 ejected
</code></pre>

<h2 id="リストア:6cd0cb3f4c453418b61672dbcf967693">リストア</h2>

<p>SDカードデバイスを確認する。</p>

<pre><code>$ diskutil list
/dev/disk1
   #:                       TYPE NAME                    SIZE       IDENTIFIER
   0:     FDisk_partition_scheme                        *32.2 GB    disk1
   1:             Windows_FAT_32 boot                    66.1 MB    disk1s1
   2:                      Linux                         32.2 GB    disk1s2
</code></pre>

<p>SDカードデバイスをアンマウントする。</p>

<pre><code>$ diskutil unmountDisk /dev/disk1
Unmount of all volumes on disk1 was successful
</code></pre>

<p>ディスクイメージをSDカードにリストアする。</p>

<pre><code>$ sudo dd bs=1m if=~/Desktop/raspi_backup.img of=/dev/rdisk1
Password:
30735+0 records in
30735+0 records out
32227983360 bytes transferred in 2153.545392 secs (14965082 bytes/sec)
</code></pre>

<p>SDカードデバイスを取り出す。</p>

<pre><code>$ diskutil eject /dev/disk1
Disk /dev/disk1 ejected
</code></pre>

<p>以上</p>

                </div>
              </article>
              
              <article>
                <div class="title">
                  <h1><a href="http://www.shinayoshi.net/post/2016/07/16/raspberrypi-kivy-setup/">RaspbianにKivyをセットアップ</a></h1>
                  <p>
                    <span class="label label-primary">Sat Jul 16, 2016</span> in
                    
                    
                    <a href="http://www.shinayoshi.net//categories/server">server</a>
                     using tags
                    
                    
                    <a href="http://www.shinayoshi.net//tags/raspberrypi">raspberrypi</a>
                    
                     , 
                    <a href="http://www.shinayoshi.net//tags/kivy">kivy</a>
                    
                  </p>
                </div>
                <div class="contents">
                  

<p>Raspberry Pi 7&rdquo; Touch Screen LCDに接続したRaspberry Pi 3 (Raspbian)にKivyをインストールしてデモを動かすまでのメモです。</p>

<h2 id="kivyのインストール:7e54fa4db923fa1d790b8a2df258af41">Kivyのインストール</h2>

<p>Kivyに必要なパッケージをインストールする。</p>

<pre><code>$ sudo apt-get update
$ sudo apt-get install libsdl2-dev libsdl2-image-dev libsdl2-mixer-dev libsdl2-ttf-dev pkg-config libgl1-mesa-dev libgles2-mesa-dev python-setuptools libgstreamer1.0-dev git-core gstreamer1.0-plugins-{bad,base,good,ugly} gstreamer1.0-{omx,alsa} python-dev cython

$ sudo reboot
</code></pre>

<p>Kivyをインストールする。</p>

<pre><code>$ git clone https://github.com/kivy/kivy
$ cd kivy
$ make
$ echo &quot;export PYTHONPATH=$(pwd):\$PYTHONPATH&quot; &gt;&gt; ~/.profile
$ source ~/.profile
</code></pre>

<ul>
<li><a href="https://kivy.org/docs/installation/installation-rpi.html">Installation on Raspberry Pi — Kivy 1.9.2-dev0 documentation</a></li>
</ul>

<h2 id="raspberry-pi-7-touch-screen-lcdの利用設定:7e54fa4db923fa1d790b8a2df258af41">Raspberry Pi 7&rdquo; Touch Screen LCDの利用設定</h2>

<pre><code>$ vi ~/.kivy/config.ini
[input]
mouse = mouse
mtdev\_%(name)s = probesysfs,provider=mtdev
hid\_%(name)s = probesysfs,provider=hidinput
</code></pre>

<h2 id="kivyデモを実行:7e54fa4db923fa1d790b8a2df258af41">Kivyデモを実行</h2>

<p>デモ実行に必要なパッケージをインストールする。</p>

<pre><code>$ sudo apt-get install xclip xsel
$ sudo pip install pygments docutils
</code></pre>

<h3 id="デモ１-showcase:7e54fa4db923fa1d790b8a2df258af41">デモ１(showcase)</h3>

<pre><code>$ cd ~/kivy/examples/demo/showcase
$ python main.py
</code></pre>

<h3 id="デモ２-3drendering:7e54fa4db923fa1d790b8a2df258af41">デモ２(3Drendering)</h3>

<pre><code>$ cd ~/kivy/examples/3Drendering
$ python main.py
</code></pre>

<h2 id="kivyのプログラムを作成-実行:7e54fa4db923fa1d790b8a2df258af41">Kivyのプログラムを作成・実行</h2>

<p><a href="http://a-zumi.net/python-kivy-simple-paint/">【Python】Kivyを使ってシンプルなペイントツールを作成する方法</a>を参考に、自前でペイントツールを作成し、実行する。</p>

<p>ソースコードを作成する。</p>

<pre><code>$ vi paint.py
</code></pre>

<script src="https://gist.github.com/kurozumi/31f250c38662a102afa5.js"></script>

<p>実行する。</p>

<pre><code>$ python paint.py  
</code></pre>

<p>Raspberry Pi 7&rdquo; Touch Screen LCDをタッチすることで線が引けることを確認する。</p>

<p>以上</p>

                </div>
              </article>
              
              <div class="pagination">
                <ul class="pager">
  
  <li class="previous"><a href="/page/2/">&larr; Newer</a></li>
  
  <li>Page 3 of 4</li>
  
  <li class="next"><a href="/page/4/">Older &rarr;</a></li>
  
</ul>

              </div>
            </div>
            <div class="sidebar col-md-3">
              <aside>
  
<section class="panel panel-default">
  <div class="panel-heading">
    <h1 class="panel-title">Profile</h1>
  </div>
  <div id="profile" class="panel-body text-center">
    <img src="http://www.shinayoshi.net//img/logo.png" alt="logo" class="img-responsive center-block" />
    <p>
      <a href="http://www.shinayoshi.net//about/">Author: shinayoshi</a>
    </p>
    <ul class="list-inline">
  
  <li>
    <a href="https://twitter.com/shinayoshi_net" target="_blank">
      <i class="fa fa-twitter-square fa-lg"></i>
    </a>
  </li>
  

  

  

  
  <li>
    <a href="https://github.com/shinayoshi" target="_blank">
      <i class="fa fa-github-square fa-lg"></i>
    </a>
  </li>
  

  
  <li>
    <a href="https://bitbucket.org/shinayoshi" target="_blank">
      <i class="fa fa-bitbucket-square fa-lg"></i>
    </a>
  </li>
  

  
  <li>
    <a href="http://www.slideshare.net/shinayoshi" target="_blank">
      <i class="fa fa-slideshare fa-lg"></i>
    </a>
  </li>
  
</ul>

  </div>
</section>

  <section class="panel panel-default">
  <div class="panel-heading">
    <h1 class="panel-title">Recent Posts</h1>
  </div>
  <div id="recent_posts" class="list-group">
    
      
      <a href="http://www.shinayoshi.net/post/2017/01/15/backup-raspberrypi/" class="list-group-item">家庭内インターネット接続環境を構築する その17 [ 2017-01-15 ]</a>
      
      <a href="http://www.shinayoshi.net/post/2017/01/12/setting-rsnapshot/" class="list-group-item">家庭内インターネット接続環境を構築する その16 [ 2017-01-12 ]</a>
      
      <a href="http://www.shinayoshi.net/post/2017/01/09/setting-snmpd/" class="list-group-item">家庭内インターネット接続環境を構築する その15 [ 2017-01-09 ]</a>
      
      <a href="http://www.shinayoshi.net/post/2017/01/09/setting-cacti/" class="list-group-item">家庭内インターネット接続環境を構築する その14 [ 2017-01-09 ]</a>
      
      <a href="http://www.shinayoshi.net/post/2017/01/09/setting-zabbix-agent/" class="list-group-item">家庭内インターネット接続環境を構築する その13 [ 2017-01-09 ]</a>
      
      <a href="http://www.shinayoshi.net/post/2017/01/08/setting-zabbix-server/" class="list-group-item">家庭内インターネット接続環境を構築する その12 [ 2017-01-08 ]</a>
      
      <a href="http://www.shinayoshi.net/post/2017/01/07/setting-rsyslog/" class="list-group-item">家庭内インターネット接続環境を構築する その11 [ 2017-01-07 ]</a>
      
      <a href="http://www.shinayoshi.net/post/2017/01/07/setting-ntp-server/" class="list-group-item">家庭内インターネット接続環境を構築する その10 [ 2017-01-07 ]</a>
      
      <a href="http://www.shinayoshi.net/post/2017/01/07/setting-cowrie-security/" class="list-group-item">家庭内インターネット接続環境を構築する その9 [ 2017-01-07 ]</a>
      
      <a href="http://www.shinayoshi.net/post/2017/01/05/setting-kippo-graph/" class="list-group-item">家庭内インターネット接続環境を構築する その8 [ 2017-01-05 ]</a>
      
      <a href="http://www.shinayoshi.net/post/2017/01/04/setting-cowrie/" class="list-group-item">家庭内インターネット接続環境を構築する その7 [ 2017-01-04 ]</a>
      
      <a href="http://www.shinayoshi.net/post/2017/01/03/setting-proxy/" class="list-group-item">家庭内インターネット接続環境を構築する その6 [ 2017-01-03 ]</a>
      
      <a href="http://www.shinayoshi.net/post/2017/01/03/setting-cache-dns/" class="list-group-item">家庭内インターネット接続環境を構築する その5 [ 2017-01-03 ]</a>
      
      <a href="http://www.shinayoshi.net/post/2017/01/02/setting-fileserver/" class="list-group-item">家庭内インターネット接続環境を構築する その4 [ 2017-01-02 ]</a>
      
      <a href="http://www.shinayoshi.net/post/2017/01/01/setting-usb-storage/" class="list-group-item">家庭内インターネット接続環境を構築する その3 [ 2017-01-01 ]</a>
      
    
  </div>
</section>

  
<section class="panel panel-default">
  <div class="panel-heading">
    <h1 class="panel-title">Categories</h1>
  </div>
  <div id="categories" class="list-group">
    
    <a href="http://www.shinayoshi.net//categories/diary" class="list-group-item"><span class="badge">2</span>diary</a>
    
    <a href="http://www.shinayoshi.net//categories/server" class="list-group-item"><span class="badge">36</span>server</a>
    
  </div>
</section>

  
<section class="panel panel-default">
  <div class="panel-heading">
    <h1 class="panel-title">Tags</h1>
  </div>
  <div id="tags" class="panel-body">
    
    
    <a href="http://www.shinayoshi.net//tags/backup" >backup (1)</a>
    
    
    
    <a href="http://www.shinayoshi.net//tags/bind" >bind (1)</a>
    
    
    
    <a href="http://www.shinayoshi.net//tags/blog" >blog (1)</a>
    
    
    
    <a href="http://www.shinayoshi.net//tags/cacti" >cacti (2)</a>
    
    
    
    <a href="http://www.shinayoshi.net//tags/centos" >centos (2)</a>
    
    
    
    <a href="http://www.shinayoshi.net//tags/cowrie" >cowrie (3)</a>
    
    
    
    <a href="http://www.shinayoshi.net//tags/fgt-60d" >fgt-60d (1)</a>
    
    
    
    <a href="http://www.shinayoshi.net//tags/fortigate" >fortigate (1)</a>
    
    
    
    <a href="http://www.shinayoshi.net//tags/home-network" >home-network (17)</a>
    
    
    
    <a href="http://www.shinayoshi.net//tags/homefw01" >homefw01 (1)</a>
    
    
    
    <a href="http://www.shinayoshi.net//tags/homemon1" >homemon1 (6)</a>
    
    
    
    <a href="http://www.shinayoshi.net//tags/homemon2" >homemon2 (6)</a>
    
    
    
    <a href="http://www.shinayoshi.net//tags/homenas1" >homenas1 (6)</a>
    
    
    
    <a href="http://www.shinayoshi.net//tags/homepot1" >homepot1 (5)</a>
    
    
    
    <a href="http://www.shinayoshi.net//tags/homepxy1" >homepxy1 (4)</a>
    
    
    
    <a href="http://www.shinayoshi.net//tags/igo" >igo (1)</a>
    
    
    
    <a href="http://www.shinayoshi.net//tags/jessie" >jessie (14)</a>
    
    
    
    <a href="http://www.shinayoshi.net//tags/kippo-graph" >kippo-graph (1)</a>
    
    
    
    <a href="http://www.shinayoshi.net//tags/kivy" >kivy (1)</a>
    
    
    
    <a href="http://www.shinayoshi.net//tags/raspberrypi" >raspberrypi (32)</a>
    
    
    
    <a href="http://www.shinayoshi.net//tags/shogi" >shogi (1)</a>
    
    
    
    <a href="http://www.shinayoshi.net//tags/squid" >squid (1)</a>
    
    
    
    <a href="http://www.shinayoshi.net//tags/wifi" >wifi (1)</a>
    
    
    
    <a href="http://www.shinayoshi.net//tags/zabbix" >zabbix (3)</a>
    
    
  </div>
</section>

</aside>

            </div>
          </div>
        </div>
      </div>

      <div class="container">
        <div class="row">
          <div class="col-md-12">
            <hr />
          </div>
        </div>
      </div>
      <footer role="contentinfo">
        <div class="container">
          <p class="text-muted credits">
            Copyright (c) 2017 shinayoshi<br />
            <small>
              <span class="credit">Powered By <a href="http://hugo.spf13.com">Hugo</a></span>
            </small>
          </p>
        </div>
      </footer>

      
      <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.3/jquery.min.js"></script>
      
      <script src="http://www.shinayoshi.net//js/bootstrap.min.js"></script>

      <script src="https://yandex.st/highlightjs/8.0/highlight.min.js"></script>
      <script>hljs.initHighlightingOnLoad();</script>
      
<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-37226857-2', 'auto');
  ga('send', 'pageview');
</script>


    </div>
  </body>
</html>

