
<!DOCTYPE html>
<html class="no-js" lang="ja">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    
    <meta name="generator" content="Hugo 0.15" />

    <base href="http://www.shinayoshi.net/" />
    <title>shinayoshi&#39;s note</title>
    <link rel="canonical" href="http://www.shinayoshi.net/" />
    <link href="http://www.shinayoshi.net//img/favicon.ico" type="image/vnd.microsoft.icon" rel="icon" />
    <link href="" rel="alternate" title="shinayoshi&#39;s note" type="application/rss+xml" />

    
    <link href="http://www.shinayoshi.net//css/bootstrap.min.css" rel="stylesheet">

    <link href="https://maxcdn.bootstrapcdn.com/font-awesome/4.4.0/css/font-awesome.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://yandex.st/highlightjs/8.0/styles/default.min.css">

    
    
    
  </head>
  <body>
    <div id="wrap">


      <header role="banner">
        <nav class="navbar navbar-default" role="navigation">
          <div class="container">
            <div class="navbar-header">
              <button type="button" class="navbar-toggle" title="toggle navbar" data-toggle="collapse" data-target=".navbar-collapse">
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
              </button>
              <a class="navbar-brand" href="http://www.shinayoshi.net//">shinayoshi&#39;s note</a>
            </div>
            <div class="navbar-collapse collapse">
              <ul class="nav navbar-nav">
                <li><a href="http://www.shinayoshi.net//">Home</a></li>
                <li><a href="http://www.shinayoshi.net//post/">All posts</a></li>
              </ul>
              <ul class="nav navbar-nav navbar-right">
                
                <li>
                  <form class="search navbar-form navbar-right" role="search" action="https://www.google.com/search" method="GET">
                    <input type="hidden" name="sitesearch" value="www.shinayoshi.net" />
                    <div class="form-group">
                      <input type="text" class="form-control" placeholder="Search" name="q" />
                    </div>
                  </form>
                </li>
                
                <li>
                  <a class="subscribe-rss" href="" title="subscribe via RSS">
                    <i class="fa fa-rss fa-lg"></i>
                  </a>
                </li>
              </ul>
            </div>
          </div>
        </nav>
      </header>


      <div id="main" role="main" class="container">
        <div id="content">
          <div class="row">
            <div class="page-content col-md-9">
              <article>
                <div class="title">
                  <h1>Raspbian(Jessie)をファイルサーバにする</h1>
                  <p>
                    <span class="label label-primary">Fri Aug 26, 2016</span> in
                    
                    
                    <a href="http://www.shinayoshi.net//categories/server">server</a>
                     using tags
                    
                    
                    <a href="http://www.shinayoshi.net//tags/raspberrypi">raspberrypi</a>
                    
                     , 
                    <a href="http://www.shinayoshi.net//tags/jessie">jessie</a>
                    
                     , 
                    <a href="http://www.shinayoshi.net//tags/raid">raid</a>
                    
                  </p>
                </div>
                <div class="panel panel-info">
                  <div class="panel-heading">
                    <p class="panel-title">Table of Contents</p>
                  </div>
                  <div class="panel-body">
                    <nav id="TableOfContents">
<ul>
<li>
<ul>
<li><a href="#mdadmのインストール:69e8e0751d383930d692b0b4fd3868b0">mdadmのインストール</a></li>
<li><a href="#raid構成の情報を削除:69e8e0751d383930d692b0b4fd3868b0">RAID構成の情報を削除</a></li>
<li><a href="#ディスクのフォーマット:69e8e0751d383930d692b0b4fd3868b0">ディスクのフォーマット</a></li>
<li><a href="#ディスクのuuidを確認:69e8e0751d383930d692b0b4fd3868b0">ディスクのUUIDを確認</a></li>
<li><a href="#mdadmでraidを構築:69e8e0751d383930d692b0b4fd3868b0">mdadmでraidを構築</a></li>
<li><a href="#フォーマット:69e8e0751d383930d692b0b4fd3868b0">フォーマット</a></li>
<li><a href="#raidディスクをマウント:69e8e0751d383930d692b0b4fd3868b0">raidディスクをマウント</a></li>
<li><a href="#起動を少し遅延させる:69e8e0751d383930d692b0b4fd3868b0">起動を少し遅延させる</a></li>
<li><a href="#ディスクの同期速度を変更する:69e8e0751d383930d692b0b4fd3868b0">ディスクの同期速度を変更する</a></li>
<li><a href="#raidの停止:69e8e0751d383930d692b0b4fd3868b0">raidの停止</a></li>
<li><a href="#nfsサーバ構築:69e8e0751d383930d692b0b4fd3868b0">NFSサーバ構築</a>
<ul>
<li><a href="#sambaサーバ構築:69e8e0751d383930d692b0b4fd3868b0">Sambaサーバ構築</a></li>
<li><a href="#samba用のユーザを作成する:69e8e0751d383930d692b0b4fd3868b0">Samba用のユーザを作成する</a></li>
</ul></li>
</ul></li>
</ul>
</nav>
                  </div>
                </div>
                <div class="contents">
                  

<p>Raspberry Pi 3をファイルサーバにします。
USB HDD 2台接続してRAID構成を組みます。</p>

<p>手順とか整理できていないのでコマンドの羅列となりますがご了承ください。
時間があるときに整理します。</p>

<h2 id="mdadmのインストール:69e8e0751d383930d692b0b4fd3868b0">mdadmのインストール</h2>

<pre><code>$ sudo apt-get install mdadm
all
</code></pre>

<h2 id="raid構成の情報を削除:69e8e0751d383930d692b0b4fd3868b0">RAID構成の情報を削除</h2>

<pre><code>$ sudo mdadm --misc --zero-superblock /dev/sda1
$ sudo mdadm --misc --zero-superblock /dev/sdb1
</code></pre>

<h2 id="ディスクのフォーマット:69e8e0751d383930d692b0b4fd3868b0">ディスクのフォーマット</h2>

<pre><code>$ sudo fdisk /dev/sda
p
d
p
n
(Enter)
(Enter)
(Enter)
(Enter)
p
t
fd
p
w

$ sudo fdisk /dev/sda
p
d
p
n
(Enter)
(Enter)
(Enter)
(Enter)
p
t
fd
p
w
</code></pre>

<h2 id="ディスクのuuidを確認:69e8e0751d383930d692b0b4fd3868b0">ディスクのUUIDを確認</h2>

<pre><code>$ sudo ls -l /dev/disk/by-id/
合計 0
lrwxrwxrwx 1 root root 13  5月 27 21:58 mmc-USDU1_0x0630017e -&gt; ../../mmcblk0
lrwxrwxrwx 1 root root 15  5月 27 21:58 mmc-USDU1_0x0630017e-part1 -&gt; ../../mmcblk0p1
lrwxrwxrwx 1 root root 15  5月 27 21:58 mmc-USDU1_0x0630017e-part2 -&gt; ../../mmcblk0p2
lrwxrwxrwx 1 root root  9  8月 26 00:12 usb-WD_My_Passport_0741_575831314136333736353632-0:0 -&gt; ../../sdb
lrwxrwxrwx 1 root root 10  8月 26 00:12 usb-WD_My_Passport_0741_575831314136333736353632-0:0-part1 -&gt; ../../sdb1
lrwxrwxrwx 1 root root  9  8月 26 00:12 usb-WD_My_Passport_0820_57583231413734354A554A46-0:0 -&gt; ../../sda
lrwxrwxrwx 1 root root 10  8月 26 00:12 usb-WD_My_Passport_0820_57583231413734354A554A46-0:0-part1 -&gt; ../../sda1
</code></pre>

<h2 id="mdadmでraidを構築:69e8e0751d383930d692b0b4fd3868b0">mdadmでraidを構築</h2>

<pre><code>$ sudo mdadm --create /dev/md0 --level=1 --raid-devices=2 /dev/disk/by-id/usb-WD_My_Passport_0820_57583231413734354A554A46-0:0-part1 /dev/disk/by-id/usb-WD_My_Passport_0741_575831314136333736353632-0:0-part1
mdadm: /dev/disk/by-id/usb-WD_My_Passport_0820_57583231413734354A554A46-0:0-part1 appears to contain an ext2fs file system
       size=976728000K  mtime=Mon Aug  3 00:40:00 2015
mdadm: /dev/disk/by-id/usb-WD_My_Passport_0820_57583231413734354A554A46-0:0-part1 appears to be part of a raid array:
       level=raid1 devices=2 ctime=Mon Aug  3 00:54:59 2015
mdadm: Note: this array has metadata at the start and
    may not be suitable as a boot device.  If you plan to
    store '/boot' on this device please ensure that
    your boot-loader understands md/v1.x metadata, or use
    --metadata=0.90
mdadm: /dev/disk/by-id/usb-WD_My_Passport_0741_575831314136333736353632-0:0-part1 appears to contain an ext2fs file system
       size=976728000K  mtime=Mon Aug  3 00:40:00 2015
mdadm: /dev/disk/by-id/usb-WD_My_Passport_0741_575831314136333736353632-0:0-part1 appears to be part of a raid array:
       level=raid1 devices=2 ctime=Mon Aug  3 00:54:59 2015
Continue creating array? yes
mdadm: Defaulting to version 1.2 metadata
mdadm: array /dev/md0 started.
</code></pre>

<pre><code>sudo cat /proc/mdstat
sudo mdadm --detail /dev/md0
</code></pre>

<pre><code>#これ不要？
$ sudo sh -c &quot;mdadm --detail --scan &gt;&gt; /etc/mdadm/mdadm.conf&quot;
$ sudo update-initramfs -u
</code></pre>

<h2 id="フォーマット:69e8e0751d383930d692b0b4fd3868b0">フォーマット</h2>

<p>md0をext4でフォーマットする。</p>

<pre><code>$ sudo mkfs.ext4 /dev/md0
y
</code></pre>

<h2 id="raidディスクをマウント:69e8e0751d383930d692b0b4fd3868b0">raidディスクをマウント</h2>

<pre><code>$ sudo mkdir /mnt/raid
$ sudo mount -t ext4 /dev/md0 /mnt/raid
$ sudo chmod 775 /mnt/raid
$ sudo chown root:adm /mnt/raid
</code></pre>

<pre><code>$ sudo blkid
$ sudo cp -p /etc/fstab{,.org}
$ sudo vi /etc/fstab
UUID=640572ce-3999-4cb3-84a0-eeeb2ce1d97d /mnt/raid ext4 defaults,noatime 0 0
</code></pre>

<h2 id="起動を少し遅延させる:69e8e0751d383930d692b0b4fd3868b0">起動を少し遅延させる</h2>

<pre><code>$ sudo cp -p /boot/cmdline.txt{,.org}
$ sudo vi /boot/cmdline.txt
dwc_otg.lpm_enable=0 console=serial0,115200 console=tty1 root=/dev/mmcblk0p2 rootfstype=ext4 elevator=deadline fsck.repair=yes rootwait rootdelay=5
</code></pre>

<pre><code>$ sudo reboot
$ df
$ sudo mdadm --detail /dev/md0
$ sudo cat /proc/mdstat
</code></pre>

<h2 id="ディスクの同期速度を変更する:69e8e0751d383930d692b0b4fd3868b0">ディスクの同期速度を変更する</h2>

<pre><code>$ cat /proc/sys/dev/raid/speed_limit_min 
1000
$ sudo sh -c &quot;echo 50000 &gt; /proc/sys/dev/raid/speed_limit_min&quot;
$ cat /proc/sys/dev/raid/speed_limit_min 
50000
</code></pre>

<h2 id="raidの停止:69e8e0751d383930d692b0b4fd3868b0">raidの停止</h2>

<pre><code>$ sudo mdadm --misc --stop /dev/md0
</code></pre>

<h2 id="nfsサーバ構築:69e8e0751d383930d692b0b4fd3868b0">NFSサーバ構築</h2>

<pre><code>$ sudo apt-get install nfs-kernel-server
$ sudo cp -p /etc/exports{,.org}
$ sudo vi /etc/exports
/mnt/raid       192.168.40.0/255.255.255.0(rw,insecure,all_squash,sync,no_subtree_check)
$ sudo systemctl restart nfs-kernel-server
$ sudo exportfs -v
</code></pre>

<h3 id="sambaサーバ構築:69e8e0751d383930d692b0b4fd3868b0">Sambaサーバ構築</h3>

<pre><code>$ sudo apt-get install samba
$ sudo cp -p /etc/samba/smb.conf{,.org}
$ sudo vi /etc/samba/smb.conf
$ diff /etc/samba/smb.conf.org /etc/samba/smb.conf
24a25,31
&gt;    unix charset = UTF-8
&gt;    dos charset = CP932
&gt;    hosts allow = 192.168.40.
&gt; 
&gt;    load printers = no
&gt;    printing = bsd
&gt;    printcap name = /dev/null
117c124
&lt;    map to guest = bad user
---
&gt;    map to guest = Never
183c190
&lt;    usershare allow guests = yes
---
&gt;    usershare allow guests = no
187,189c194,196
&lt; [homes]
&lt;    comment = Home Directories
&lt;    browseable = no
---
&gt; ;[homes]
&gt; ;   comment = Home Directories
&gt; ;   browseable = no
193c200
&lt;    read only = yes
---
&gt; ;   read only = yes
197c204
&lt;    create mask = 0700
---
&gt; ;   create mask = 0700
201c208
&lt;    directory mask = 0700
---
&gt; ;   directory mask = 0700
208c215
&lt;    valid users = %S
---
&gt; ;   valid users = %S
231,238c238,245
&lt; [printers]
&lt;    comment = All Printers
&lt;    browseable = no
&lt;    path = /var/spool/samba
&lt;    printable = yes
&lt;    guest ok = no
&lt;    read only = yes
&lt;    create mask = 0700
---
&gt; ;[printers]
&gt; ;   comment = All Printers
&gt; ;   browseable = no
&gt; ;   path = /var/spool/samba
&gt; ;   printable = yes
&gt; ;   guest ok = no
&gt; ;   read only = yes
&gt; ;   create mask = 0700
242,247c249,254
&lt; [print$]
&lt;    comment = Printer Drivers
&lt;    path = /var/lib/samba/printers
&lt;    browseable = yes
&lt;    read only = yes
&lt;    guest ok = no
---
&gt; ;[print$]
&gt; ;   comment = Printer Drivers
&gt; ;   path = /var/lib/samba/printers
&gt; ;   browseable = yes
&gt; ;   read only = yes
&gt; ;   guest ok = no
254a262,269
&gt; [share]
&gt;    path = /mnt/raid
&gt;    writable = yes
&gt;    valid users = @sambashare
&gt;    force user = root
&gt;    force group = adm
&gt;    create mask = 0664
&gt;    directory mask = 0775
$ testparm /etc/samba/smb.conf
$ sudo systemctl restart smbd
$ sudo systemctl restart nmbd
</code></pre>

<h3 id="samba用のユーザを作成する:69e8e0751d383930d692b0b4fd3868b0">Samba用のユーザを作成する</h3>

<pre><code>$ sudo useradd samba -u 1100 -g sambashare -s /bin/false
$ sudo passwd samba
$ sudo pdbedit -a -u samba
</code></pre>

<p>以上</p>

                  
<div id="disqus_thread"></div>
<script type="text/javascript">
   
  var disqus_shortname = 'shinayoshi';

   
  (function() {
  var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
  dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
  (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
  })();
</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript" rel="nofollow">comments powered by Disqus.</a></noscript>


                </div>
              </article>
              <div class="pagination">
                <ul class="pager">
                  
                  <li class="next"><a href="http://www.shinayoshi.net/post/2016/08/24/cache-dns-on-raspbian/">Raspbian(Jessie)でキャッシュDNSを構築する</a></li>
                  
                  
                </ul>
              </div>
            </div>
            <div class="sidebar col-md-3">
              <aside>
  
<section class="panel panel-default">
  <div class="panel-heading">
    <h1 class="panel-title">Profile</h1>
  </div>
  <div id="profile" class="panel-body text-center">
    <img src="http://www.shinayoshi.net//img/logo.png" alt="logo" class="img-responsive center-block" />
    <p>
      <a href="http://www.shinayoshi.net//about/">Author: shinayoshi</a>
    </p>
    <ul class="list-inline">
  

  

  

  
  <li>
    <a href="https://github.com/shinayoshi" target="_blank">
      <i class="fa fa-github-square fa-lg"></i>
    </a>
  </li>
  

  
  <li>
    <a href="https://bitbucket.org/shinayoshi" target="_blank">
      <i class="fa fa-bitbucket-square fa-lg"></i>
    </a>
  </li>
  

  
  <li>
    <a href="http://www.slideshare.net/shinayoshi" target="_blank">
      <i class="fa fa-slideshare fa-lg"></i>
    </a>
  </li>
  
</ul>

  </div>
</section>

  <section class="panel panel-default">
  <div class="panel-heading">
    <h1 class="panel-title">Recent Posts</h1>
  </div>
  <div id="recent_posts" class="list-group">
    
      
      <a href="http://www.shinayoshi.net/post/2016/08/26/setting-file-server/" class="list-group-item">Raspbian(Jessie)をファイルサーバにする [ 2016-08-26 ]</a>
      
      <a href="http://www.shinayoshi.net/post/2016/08/24/cache-dns-on-raspbian/" class="list-group-item">Raspbian(Jessie)でキャッシュDNSを構築する [ 2016-08-24 ]</a>
      
      <a href="http://www.shinayoshi.net/post/2016/08/22/installing-squid-on-raspbian/" class="list-group-item">Raspbian(Jessie)にSquidをインストールする [ 2016-08-22 ]</a>
      
      <a href="http://www.shinayoshi.net/post/2016/08/21/to-register-the-device-in-cacti/" class="list-group-item">Cactiにデバイスを登録する [ 2016-08-21 ]</a>
      
      <a href="http://www.shinayoshi.net/post/2016/08/20/installing-cacti-on-raspberrypi/" class="list-group-item">Raspbian(Jessie)にCactiをインストールする [ 2016-08-20 ]</a>
      
      <a href="http://www.shinayoshi.net/post/2016/08/16/security-setting-on-cowrie/" class="list-group-item">Cowrieのセキュリティ設定 [ 2016-08-16 ]</a>
      
      <a href="http://www.shinayoshi.net/post/2016/08/16/install-kippo-graph/" class="list-group-item">Kippo-GraphをインストールしてCowrieのログを可視化する [ 2016-08-16 ]</a>
      
      <a href="http://www.shinayoshi.net/post/2016/08/15/install-cowrie-on-raspbian/" class="list-group-item">Raspbian(Jessie)にCowrieをインストールする [ 2016-08-15 ]</a>
      
      <a href="http://www.shinayoshi.net/post/2016/08/13/add-fortigate-mib-on-raspbian/" class="list-group-item">Raspbian(Jessie)にFortiGateのプライベートMIBを追加する [ 2016-08-13 ]</a>
      
      <a href="http://www.shinayoshi.net/post/2016/08/11/monitoring-snmp-devices-on-zabbix/" class="list-group-item">ZabbixでSNMPデバイスの監視を行う [ 2016-08-11 ]</a>
      
    
  </div>
</section>

  
<section class="panel panel-default">
  <div class="panel-heading">
    <h1 class="panel-title">Categories</h1>
  </div>
  <div id="categories" class="list-group">
    
    <a href="http://www.shinayoshi.net//categories/diary" class="list-group-item"><span class="badge">2</span>diary</a>
    
    <a href="http://www.shinayoshi.net//categories/server" class="list-group-item"><span class="badge">20</span>server</a>
    
  </div>
</section>

  
<section class="panel panel-default">
  <div class="panel-heading">
    <h1 class="panel-title">Tags</h1>
  </div>
  <div id="tags" class="panel-body">
    
    
    <a href="http://www.shinayoshi.net//tags/backup" >backup (1)</a>
    
    
    
    <a href="http://www.shinayoshi.net//tags/bind" >bind (1)</a>
    
    
    
    <a href="http://www.shinayoshi.net//tags/blog" >blog (1)</a>
    
    
    
    <a href="http://www.shinayoshi.net//tags/cacti" >cacti (2)</a>
    
    
    
    <a href="http://www.shinayoshi.net//tags/centos" >centos (2)</a>
    
    
    
    <a href="http://www.shinayoshi.net//tags/cowrie" >cowrie (3)</a>
    
    
    
    <a href="http://www.shinayoshi.net//tags/fgt-60d" >fgt-60d (1)</a>
    
    
    
    <a href="http://www.shinayoshi.net//tags/igo" >igo (1)</a>
    
    
    
    <a href="http://www.shinayoshi.net//tags/jessie" >jessie (15)</a>
    
    
    
    <a href="http://www.shinayoshi.net//tags/kippo-graph" >kippo-graph (1)</a>
    
    
    
    <a href="http://www.shinayoshi.net//tags/kivy" >kivy (1)</a>
    
    
    
    <a href="http://www.shinayoshi.net//tags/raid" >raid (1)</a>
    
    
    
    <a href="http://www.shinayoshi.net//tags/raspberrypi" >raspberrypi (16)</a>
    
    
    
    <a href="http://www.shinayoshi.net//tags/shogi" >shogi (1)</a>
    
    
    
    <a href="http://www.shinayoshi.net//tags/squid" >squid (1)</a>
    
    
    
    <a href="http://www.shinayoshi.net//tags/wifi" >wifi (1)</a>
    
    
    
    <a href="http://www.shinayoshi.net//tags/zabbix" >zabbix (3)</a>
    
    
  </div>
</section>

</aside>

            </div>
          </div>
        </div>
      </div>

      <div class="container">
        <div class="row">
          <div class="col-md-12">
            <hr />
          </div>
        </div>
      </div>
      <footer role="contentinfo">
        <div class="container">
          <p class="text-muted credits">
            Copyright (c) 2016 shinayoshi<br />
            <small>
              <span class="credit">Powered By <a href="http://hugo.spf13.com">Hugo</a></span>
            </small>
          </p>
        </div>
      </footer>

      
      <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.3/jquery.min.js"></script>
      
      <script src="http://www.shinayoshi.net//js/bootstrap.min.js"></script>

      <script src="https://yandex.st/highlightjs/8.0/highlight.min.js"></script>
      <script>hljs.initHighlightingOnLoad();</script>
      
<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-37226857-2', 'auto');
  ga('send', 'pageview');
</script>


    </div>
  </body>
</html>

